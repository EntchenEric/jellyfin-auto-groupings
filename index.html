<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin Groupings | Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d0d12;
            --surface-color: #1a1a24;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 6px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 340px;
            --topbar-height: 58px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* â”€â”€ Background blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            z-index: 0;
            pointer-events: none;
            filter: blur(90px);
            animation: blobFloat 22s ease-in-out infinite alternate;
        }

        .bg-blob-1 {
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.12) 0%, transparent 70%);
            top: -200px;
            left: -200px;
        }

        .bg-blob-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.08) 0%, transparent 70%);
            bottom: -150px;
            right: -100px;
            animation-delay: -10s;
        }

        @keyframes blobFloat {
            0% {
                transform: translate(0, 0) scale(1);
            }

            100% {
                transform: translate(40px, 30px) scale(1.12);
            }
        }

        /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0 1.5rem;
            background: rgba(13, 13, 18, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        #topbar .brand {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
            flex-shrink: 0;
        }

        #topbar .brand h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
        }

        .topbar-spacer {
            flex: 1;
        }

        /* connection status pill */
        #connection-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 0.3rem 0.8rem;
            white-space: nowrap;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            flex-shrink: 0;
        }

        .connection-dot.online {
            background: var(--success-color);
            box-shadow: 0 0 6px var(--success-color);
        }

        .connection-dot.offline {
            background: var(--error-color);
            box-shadow: 0 0 6px var(--error-color);
        }

        /* topbar action buttons */
        .topbar-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .topbar-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.42rem 0.9rem;
            border-radius: var(--radius-md);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            white-space: nowrap;
            font-family: inherit;
        }

        .topbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.18);
            color: var(--text-primary);
        }

        .topbar-btn.primary {
            background: var(--accent-color);
            border-color: transparent;
            color: #fff;
        }

        .topbar-btn.primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.35);
        }

        .topbar-btn.danger {
            border-color: rgba(239, 68, 68, 0.35);
            color: var(--error-color);
        }

        .topbar-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error-color);
        }

        .topbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #hamburger-btn {
            display: none;
            padding: 0.4rem 0.6rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* â”€â”€ App shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #app-layout {
            position: fixed;
            top: var(--topbar-height);
            left: 0;
            right: 0;
            bottom: 0;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            z-index: 1;
        }

        /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #sidebar {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(255, 255, 255, 0.015);
            border-right: 1px solid var(--glass-border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        #sidebar::-webkit-scrollbar {
            width: 5px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #main-content {
            height: 100%;
            overflow-y: auto;
            padding: 1.75rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.08) transparent;
        }

        #main-content::-webkit-scrollbar {
            width: 5px;
        }

        #main-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
        }

        /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: rgba(255, 255, 255, 0.035);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }

        .card-sm {
            padding: 1rem 1.25rem;
        }

        h2,
        h3 {
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .section-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        /* â”€â”€ How it works (sidebar tip cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .how-step {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            padding: 0.75rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
        }

        .step-num {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.78rem;
            flex-shrink: 0;
        }

        .step-body {
            font-size: 0.78rem;
        }

        .step-body strong {
            display: block;
            margin-bottom: 0.15rem;
            font-size: 0.82rem;
        }

        .step-body span {
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 600;
            font-size: 0.72rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="url"],
        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 0.65rem 0.9rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
            background: rgba(0, 0, 0, 0.3);
        }

        select {
            width: 100%;
            padding: 0.65rem 0.9rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            appearance: none;
            cursor: pointer;
            transition: var(--transition);
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        small,
        .hint {
            display: block;
            margin-top: 0.3rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        button {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.4rem;
            font-family: inherit;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: none;
        }

        .delete-btn {
            background: transparent;
            color: var(--error-color);
            border: 1px solid var(--error-color);
            padding: 0.4rem 0.7rem;
            font-size: 0.78rem;
            width: auto;
            margin: 0;
        }

        .delete-btn:hover {
            background: var(--error-color);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
            margin-top: 0.75rem;
        }

        .btn-row button {
            margin-top: 0;
        }

        /* â”€â”€ Group cards (responsive grid) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #groups-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .group-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 0.9rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            /* Allow wrapping if too tight */
            transition: var(--transition);
            gap: 1rem;
            /* slightly increased gap */
        }

        .group-card:hover {
            border-color: rgba(99, 102, 241, 0.4);
            background: rgba(255, 255, 255, 0.07);
        }

        .group-info {
            flex: 1 1 200px;
            /* Take available space, min width 200px before wrapping */
            min-width: 0;
        }

        .group-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            /* Keep buttons from shrinking */
        }

        .group-info h4 {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: normal;
            /* Don't truncate name */
            line-height: 1.3;
        }

        .group-meta {
            font-size: 0.78rem;
            color: var(--text-secondary);
            white-space: normal;
            /* Don't truncate meta */
            line-height: 1.4;
        }

        /* â”€â”€ Status messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-msg {
            margin-top: 0.75rem;
            text-align: center;
            font-weight: 500;
            padding: 0.65rem;
            border-radius: var(--radius-md);
            display: none;
            font-size: 0.85rem;
            animation: slideIn 0.25s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-msg.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-msg.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* fixed toast at bottom right */
        #status-msg {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            margin: 0;
            max-width: 360px;
            z-index: 200;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        /* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.25);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: none;
            flex-shrink: 0;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            width: min(500px, 95vw);
            max-width: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.2rem 1.5rem 1rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
            width: auto;
            margin: 0;
        }

        .close-btn:hover {
            color: var(--error-color);
            background: none;
            transform: none;
            box-shadow: none;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .modal-footer button {
            width: auto;
            margin: 0;
            padding: 0.6rem 1.2rem;
        }

        .btn-loading .loading-spinner {
            display: block;
        }

        .btn-loading .btn-text {
            display: none;
        }

        /* â”€â”€ Section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }

        .section-header h2 {
            margin-bottom: 0;
        }

        /* â”€â”€ Sub-panels (dashed inset boxes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sub-panel {
            padding: 0.9rem;
            background: rgba(0, 0, 0, 0.12);
            border-radius: var(--radius-md);
            border: 1px dashed var(--glass-border);
            margin-top: 0.75rem;
        }

        .sub-panel-accent {
            background: rgba(99, 102, 241, 0.04);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        .sub-panel>h3 {
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
        }

        /* â”€â”€ Locked overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .locked-section {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.2);
            position: relative;
        }

        .locked-overlay-text {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-5deg);
            background: var(--error-color);
            color: white;
            padding: 0.35rem 0.8rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            pointer-events: none;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .locked-section .locked-overlay-text {
            display: block;
        }

        /* â”€â”€ Picker row (path input + browse btn) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .picker-row {
            display: flex;
            gap: 0.4rem;
            align-items: stretch;
        }

        .picker-row input {
            flex: 1;
            min-width: 0;
            margin: 0;
        }

        .browse-btn {
            flex-shrink: 0;
            width: auto;
            padding: 0 0.8rem;
            margin: 0;
            font-size: 0.8rem;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .browse-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--text-primary);
            transform: none;
            box-shadow: none;
        }

        .browse-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .path-field-locked {
            opacity: 0.45;
            pointer-events: none;
        }

        /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        /* â”€â”€ Folder picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #path-picker-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .picker-box {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            width: min(600px, 95vw);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        .picker-header {
            padding: 1rem 1.25rem 0.7rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .picker-title {
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .picker-breadcrumb {
            font-size: 0.75rem;
            color: var(--text-secondary);
            word-break: break-all;
            font-family: monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            border: 1px solid var(--glass-border);
        }

        .picker-body {
            overflow-y: auto;
            flex: 1;
            padding: 0.4rem 0;
        }

        .picker-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 1.25rem;
            cursor: pointer;
            font-size: 0.88rem;
            color: var(--text-primary);
            transition: background 0.12s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .picker-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .picker-item.picker-up {
            color: var(--text-secondary);
            font-style: italic;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 0.2rem;
        }

        .picker-item-icon {
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .picker-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.82rem;
            font-style: italic;
        }

        .picker-footer {
            padding: 0.85rem 1.25rem;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 0.6rem;
            align-items: center;
        }

        .picker-footer-path {
            flex: 1;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* â”€â”€ Modal items (for export/import lists) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-item {
            padding: 0.7rem 0.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 0.85rem;
        }

        .modal-item:last-child {
            border-bottom: none;
        }

        /* â”€â”€ Connection warning banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #connection-warning {
            margin: 0.75rem 0;
            display: none;
        }

        /* â”€â”€ Sync/maintenance action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .action-btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .action-btn-group button {
            margin-top: 0;
        }

        /* â”€â”€ 2-col form grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        /* â”€â”€ Checkbox label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .checkbox-label {
            display: flex !important;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            text-transform: none !important;
            font-size: 0.8rem !important;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.04em;
            margin-bottom: 0 !important;
        }

        .checkbox-label input[type="checkbox"] {
            width: 15px;
            height: 15px;
            accent-color: var(--accent-color);
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-label span {
            text-transform: uppercase;
        }

        /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #main-content>* {
            animation: fadeIn 0.4s ease-out;
        }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .footer {
            margin-top: auto;
            padding-top: 1rem;
            font-size: 0.72rem;
            color: rgba(148, 163, 184, 0.45);
            text-align: center;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           MOBILE  (< 768px)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {

            html,
            body {
                overflow: auto;
                height: auto;
            }

            #topbar {
                padding: 0 1rem;
                gap: 0.6rem;
            }

            #topbar .brand h1 {
                font-size: 1rem;
            }

            #hamburger-btn {
                display: flex;
                align-items: center;
            }

            .topbar-actions .topbar-btn:not(.primary) {
                display: none;
            }

            #app-layout {
                position: static;
                display: block;
                margin-top: var(--topbar-height);
            }

            #sidebar {
                height: auto;
                overflow: visible;
                display: none;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                padding: 1rem;
            }

            #sidebar.open {
                display: flex;
            }

            #main-content {
                height: auto;
                overflow: visible;
                padding: 1rem;
            }

            #groups-list {
                grid-template-columns: 1fr;
            }

            .form-grid-2 {
                grid-template-columns: 1fr;
            }

            .btn-row {
                grid-template-columns: 1fr;
            }
        }



        #sidebar-resizer {
            width: 8px;
            cursor: col-resize;
            position: absolute;
            top: 0;
            bottom: 0;
            left: var(--sidebar-width);
            transform: translateX(-50%);
            z-index: 100;
            background: transparent;
            transition: background 0.2s ease;
        }

        #sidebar-resizer:hover,
        #sidebar-resizer.active {
            background: rgba(99, 102, 241, 0.5);
            /* var(--accent-color) */
        }
    </style>
</head>

<body>
    <!-- Background blobs -->
    <div class="bg-blob bg-blob-1"></div>
    <div class="bg-blob bg-blob-2"></div>

    <!-- â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header id="topbar">
        <button id="hamburger-btn" onclick="document.getElementById('sidebar').classList.toggle('open')"
            title="Menu">â˜°</button>
        <div class="brand">
            <h1>Jellyfin Groupings</h1>
        </div>

        <div id="connection-status">
            <span class="connection-dot" id="status-dot"></span>
            <span id="status-text">Disconnected</span>
        </div>

        <div class="topbar-spacer"></div>

        <div class="topbar-actions">
            <button id="topbar-preview-btn" class="topbar-btn" onclick="previewSyncAll()">
                <span class="loading-spinner" id="topbar-preview-spinner" style="border-top-color:#fff;"></span>
                <span class="btn-text">ğŸ‘ Preview</span>
            </button>
            <button id="topbar-sync-btn" class="topbar-btn primary" onclick="syncAll()">
                <span class="loading-spinner" id="topbar-sync-spinner" style="border-top-color:#fff;"></span>
                <span class="btn-text">ğŸš€ Sync All</span>
            </button>
            <button class="topbar-btn danger" onclick="openCleanupModal()">ğŸ§¹ Clean Up</button>
            <button class="topbar-btn" onclick="openExportModal()">â¬‡ Export</button>
            <button class="topbar-btn" onclick="openImportModal()">â¬† Import</button>
        </div>
    </header>

    <!-- â”€â”€ App Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="app-layout">

        <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sidebar-resizer" title="Drag to resize sidebar"></div>
        <aside id="sidebar">

            <!-- Connectivity Warning -->
            <div id="connection-warning" class="status-msg error"
                style="margin: 0; padding: 0.9rem; border-radius: var(--radius-md);">
                <h3 style="color: var(--error-color); font-size: 0.85rem; margin-bottom: 0.3rem;">âš ï¸ Server Not
                    Connected</h3>
                <p style="font-size: 0.75rem; margin-bottom: 0.5rem;">Open this via <code>python app.py</code> at
                    <a href="http://localhost:5000"
                        style="color: var(--accent-color); font-weight: 600;">localhost:5000</a>.
                </p>
            </div>

            <!-- â‘  Server Settings -->
            <section class="card" style="padding: 1.25rem;">
                <div class="section-header">
                    <h2 style="margin-bottom:0;">â‘  Server Settings</h2>
                </div>
                <p class="section-desc">Point this tool at your Jellyfin server to get started.</p>

                <form id="config-form">
                    <div class="form-group">
                        <label for="jellyfin_url">Jellyfin Server URL</label>
                        <input type="url" id="jellyfin_url" placeholder="https://jellyfin.yourdomain.com" required>
                        <small>Full URL including protocol and port.</small>
                    </div>
                    <div class="form-group">
                        <label for="api_key">API Key</label>
                        <input type="password" id="api_key" placeholder="Your Jellyfin API Key" required>
                        <small>Dashboard â†’ API Keys.</small>
                    </div>
                    <div class="form-group">
                        <label for="target_path">Base Target Path</label>
                        <div id="target_path_group" class="picker-row path-field-locked">
                            <input type="text" id="target_path" placeholder="/path/to/virtual/libraries" required
                                disabled>
                            <button type="button" class="browse-btn" onclick="openPathPicker('target_path')" disabled
                                title="Browse">ğŸ“‚</button>
                        </div>
                        <small>Where symlink folders will be created on <em>this machine</em>.</small>
                    </div>

                    <!-- Path Translation -->
                    <div class="sub-panel" style="margin-top: 0.75rem;">
                        <h3 style="font-size: 0.82rem; display: flex; align-items: center; gap: 0.4rem;">
                            ğŸ—‚ï¸ Media Path Translation <span
                                style="font-weight: 400; color: var(--text-secondary); font-size: 0.78rem;">(Optional)</span>
                        </h3>
                        <p
                            style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.4;">
                            Only needed when Jellyfin paths differ from this machine's paths (e.g. Docker).</p>
                        <div class="form-group">
                            <label style="font-size: 0.68rem;">Path in Jellyfin</label>
                            <div id="media_path_in_jellyfin_group" class="picker-row path-field-locked">
                                <input type="text" id="media_path_in_jellyfin" placeholder="/media"
                                    style="font-size:0.82rem; padding: 0.5rem 0.7rem;" disabled>
                                <button type="button" class="browse-btn"
                                    onclick="openPathPicker('media_path_in_jellyfin')" disabled>ğŸ“‚</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label style="font-size: 0.68rem;">Same path on this machine</label>
                            <div id="media_path_on_host_group" class="picker-row path-field-locked">
                                <input type="text" id="media_path_on_host" placeholder="/home/user/media"
                                    style="font-size:0.82rem; padding: 0.5rem 0.7rem;" disabled>
                                <button type="button" class="browse-btn" onclick="openPathPicker('media_path_on_host')"
                                    disabled>ğŸ“‚</button>
                            </div>
                        </div>
                    </div>

                    <!-- Auto Library Creation -->
                    <div class="sub-panel sub-panel-accent" style="margin-top: 0.75rem;">
                        <h3
                            style="font-size: 0.82rem; color: var(--accent-color); display: flex; align-items: center; gap: 0.4rem;">
                            ğŸš€ Automatic Library Creation</h3>
                        <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                            <input type="checkbox" id="auto_create_libraries"
                                style="width:15px;height:15px;accent-color:var(--accent-color);">
                            <span>Auto-Create Libraries in Jellyfin</span>
                        </label>
                        <p
                            style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.4;">
                            Automatically creates a Jellyfin library for each grouping after syncing.</p>

                        <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                            <input type="checkbox" id="auto_set_library_covers"
                                style="width:15px;height:15px;accent-color:var(--accent-color);">
                            <span>Auto-Set Library Covers</span>
                        </label>
                        <p
                            style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.4;">
                            Automatically upload the generated cover directly to the Jellyfin library upon sync.
                            Requires Library Creation above.</p>

                        <label style="font-size: 0.68rem; opacity: 0.8;">Target path as Jellyfin sees it
                            (optional)</label>
                        <div id="target_path_in_jellyfin_group" class="picker-row path-field-locked">
                            <input type="text" id="target_path_in_jellyfin" placeholder="/groupings"
                                style="font-size:0.82rem; padding: 0.5rem 0.7rem;" disabled>
                            <button type="button" class="browse-btn" onclick="openPathPicker('target_path_in_jellyfin')"
                                disabled>ğŸ“‚</button>
                        </div>
                    </div>

                    <div class="btn-row" style="margin-top: 0.75rem;">
                        <button type="button" id="auto-detect-btn" onclick="autoDetectPaths()" class="secondary-btn"
                            style="border-color: var(--accent-color); color: var(--accent-color);">
                            <span class="loading-spinner"></span>
                            <span class="btn-text">âœ¨ Auto-Detect</span>
                        </button>
                        <button type="button" id="test-btn" onclick="testConnection()" class="secondary-btn">
                            <span class="loading-spinner"></span>
                            <span class="btn-text">âš¡ Test</span>
                        </button>
                    </div>
                    <button type="submit" id="save-btn" style="margin-top: 0.5rem;">
                        <span class="loading-spinner"></span>
                        <span class="btn-text">Save Server Settings</span>
                    </button>
                </form>
            </section>

            <!-- â‘£ Scheduler -->
            <section class="card locked-section" id="scheduler-card" style="padding: 1.25rem;">
                <div class="locked-overlay-text">Server Required</div>
                <h2>â‘£ Auto Sync Scheduling</h2>
                <p class="section-desc">Configure automatic sync schedules.</p>

                <div class="sub-panel">
                    <label class="checkbox-label">
                        <input type="checkbox" id="global_scheduler_enabled" onchange="toggleGlobalScheduler(this)"
                            style="width:15px;height:15px;accent-color:var(--accent-color);">
                        <span>Enable Global Scheduler</span>
                    </label>

                    <div id="global_scheduler_panel" style="display: none; margin-top: 0.75rem;">
                        <div class="form-group">
                            <label for="global_sync_schedule">Global Sync Schedule (Cron)</label>
                            <input type="text" id="global_sync_schedule" placeholder="0 0 * * * (Every midnight)"
                                style="font-size:0.85rem;">
                            <small>Standard crontab: <code>minute hour day month weekday</code></small>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Excluded Groupings</label>
                            <div id="global_sync_exclusions"
                                style="max-height: 130px; overflow-y: auto; background: rgba(0,0,0,0.15); padding: 0.5rem; border-radius: var(--radius-sm); display: flex; flex-direction: column; gap: 0.3rem;">
                                <!-- Checkboxes injected by JS -->
                            </div>
                            <small>These groupings skip the global scheduled sync.</small>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; border-top: 1px dashed var(--glass-border); padding-top: 1rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="cleanup_scheduler_enabled"
                                onchange="toggleCleanupScheduler(this)"
                                style="width:15px;height:15px;accent-color:var(--accent-color);">
                            <span>Enable Auto-Cleanup</span>
                        </label>
                        <div id="cleanup_scheduler_panel" style="display: none; margin-top: 0.75rem;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="cleanup_sync_schedule">Cleanup Schedule (Cron)</label>
                                <input type="text" id="cleanup_sync_schedule" placeholder="0 * * * * (Every hour)"
                                    style="font-size:0.85rem;">
                                <small>Removes broken symlinks when originals are deleted.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- How it Works guide -->
            <section style="display: flex; flex-direction: column; gap: 0.6rem;">
                <p
                    style="font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;">
                    How It Works</p>
                <div class="how-step">
                    <div class="step-num">1</div>
                    <div class="step-body"><strong>Connect Jellyfin</strong><span>Enter your server URL and API
                            key.</span></div>
                </div>
                <div class="how-step">
                    <div class="step-num">2</div>
                    <div class="step-body"><strong>Define Groupings</strong><span>Each grouping becomes a virtual
                            Jellyfin library.</span></div>
                </div>
                <div class="how-step">
                    <div class="step-num">3</div>
                    <div class="step-body"><strong>Sync &amp; Add</strong><span>Sync creates symlinks. Then add each
                            folder as a library in Jellyfin (Mixed Movies and Shows).</span></div>
                </div>
            </section>

            <div class="footer">
                <p>Run <code>python app.py</code> Â· Jellyfin Groupings</p>
            </div>

        </aside>

        <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <main id="main-content">

            <!-- â‘¢ Sync & Maintenance -->
            <section class="card locked-section" id="maintenance-card">
                <div class="locked-overlay-text">Server Required</div>
                <div class="section-header">
                    <h2>â‘¢ Sync &amp; Maintenance</h2>
                </div>
                <p class="section-desc">After defining your groupings, press Sync to build the symlink folders on disk.
                </p>


                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                    <div>
                        <button id="sync-btn" onclick="syncAll()"
                            style="width: 100%; background: var(--accent-color); border: none; font-weight: 600; margin: 0;">
                            <span class="loading-spinner"></span>
                            <span class="btn-text">ğŸš€ Sync All Groupings</span>
                        </button>
                        <p
                            style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.3rem; text-align: center;">
                            Creates symlinks for every grouping.</p>
                    </div>
                    <div>
                        <button id="preview-sync-btn" onclick="previewSyncAll()" class="secondary-btn"
                            style="width: 100%; font-weight: 600; margin: 0;">
                            <span class="loading-spinner"></span>
                            <span class="btn-text">ğŸ‘ï¸ Preview Sync</span>
                        </button>
                        <p
                            style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.3rem; text-align: center;">
                            Dry-run without touching disk.</p>
                    </div>
                    <div>
                        <button id="cleanup-btn" onclick="openCleanupModal()" class="secondary-btn"
                            style="width: 100%; font-weight: 600; margin: 0; border-color: var(--error-color); color: var(--error-color);">
                            <span class="loading-spinner"></span>
                            <span class="btn-text">ğŸ§¹ Clean Up Folders</span>
                        </button>
                        <p
                            style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.3rem; text-align: center;">
                            Delete old grouping folders from disk.</p>
                    </div>
                    <div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button onclick="openExportModal()" class="secondary-btn"
                                style="margin: 0; padding: 0.65rem 0.5rem; font-size: 0.8rem;">â¬‡ Export</button>
                            <button onclick="openImportModal()" class="secondary-btn"
                                style="margin: 0; padding: 0.65rem 0.5rem; font-size: 0.8rem;">â¬† Import</button>
                        </div>
                        <p
                            style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.3rem; text-align: center;">
                            Backup / restore config JSON.</p>
                    </div>
                </div>
            </section>

            <!-- â‘¡ Groupings -->
            <section class="card locked-section" id="groupings-section">
                <div class="locked-overlay-text">Server Required</div>
                <div class="section-header">
                    <h2>â‘¡ Groupings</h2>
                    <button onclick="clearAllGroups()" class="secondary-btn delete-btn"
                        style="border: none; font-size: 0.78rem;" title="Remove All Groupings">Clear All</button>
                </div>
                <p class="section-desc">Each grouping becomes a virtual Jellyfin library. Define as many as you like â€”
                    e.g. one per genre, actor, or IMDb list.</p>

                <div id="groups-list">
                    <!-- Group cards injected here -->
                </div>

                <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 1.25rem 0;">

                <h3 id="group-form-title"
                    style="margin-bottom: 1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    Create New Grouping</h3>
                <form id="group-form"
                    style="background: rgba(0,0,0,0.15); border: 1px solid var(--glass-border); padding: 1.5rem; border-radius: var(--radius-lg);">

                    <h4 style="font-size: 0.9rem; color: var(--accent-color); margin-bottom: 1rem; margin-top: 0;">1.
                        Basic Info</h4>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="group_name">Group Name</label>
                        <input type="text" id="group_name" placeholder="Action Movies" required>
                        <small>Becomes the folder name and Jellyfin library name.</small>
                    </div>

                    <h4
                        style="font-size: 0.9rem; color: var(--accent-color); margin-bottom: 1rem; margin-top: 1.5rem; border-top: 1px dashed var(--glass-border); padding-top: 1.5rem;">
                        2. Source Filtering</h4>

                    <div class="form-grid-2">
                        <div class="form-group" style="margin-bottom:0;">
                            <label for="source_category">Source Category</label>
                            <select id="source_category" onchange="updateSourceTypeOptions()">
                                <option value="jellyfin">Jellyfin (Integrated)</option>
                                <option value="external">External (3rd Party)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label for="source_type">Filter By</label>
                            <select id="source_type" onchange="updateSourceValueUI()">
                                <!-- Options injected via JS -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label for="source_value">Filter Value</label>

                        <div id="metadata_rules_container"
                            style="display: none; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <button type="button" onclick="addMetadataRule()" class="secondary-btn" id="add-rule-btn"
                            style="display: none; margin-bottom: 0.5rem; padding: 0.35rem 0.75rem; font-size: 0.82rem; width: fit-content; margin-top:0;">+
                            Add Condition</button>

                        <div id="source_value_container" style="display: flex; gap: 0.5rem; flex-direction: column;">
                            <input type="text" id="source_value" list="source_value_datalist"
                                placeholder="Action  or  ls000024390" required>
                            <datalist id="source_value_datalist"></datalist>
                            <button type="button" onclick="previewGrouping()" class="secondary-btn" id="preview-btn"
                                style="padding: 0.5rem 0.9rem; font-size: 0.85rem; align-self: flex-start; margin: 0;">Preview
                                Filter</button>
                        </div>
                        <small id="source_value_help">
                            The specific genre, actor name, tag, or list ID.<br>
                            <span style="color: var(--accent-color);">Tip: Chain logic operators â€” e.g.
                                <code>Horror AND Action AND NOT Comedy</code></span>
                        </small>

                        <div id="preview_result"
                            style="display: none; margin-top: 0.75rem; font-size: 0.8rem; padding: 0.9rem; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); border: 1px dashed var(--glass-border);">
                        </div>
                    </div>

                    <div class="form-grid-2">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="watch_state">Watch State Filter</label>
                            <select id="watch_state">
                                <option value="">All Items (Default)</option>
                                <option value="unwatched">Unwatched Only</option>
                                <option value="watched">Watched Only</option>
                            </select>
                            <small>Filter by played status in Jellyfin.</small>
                        </div>
                    </div>

                    <h4
                        style="font-size: 0.9rem; color: var(--accent-color); margin-bottom: 1rem; margin-top: 1.5rem; border-top: 1px dashed var(--glass-border); padding-top: 1.5rem;">
                        3. Advanced Options</h4>

                    <!-- Sort Order -->
                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sort_order_enabled" onchange="toggleSortOrder(this)"
                                style="width:14px;height:14px;accent-color:var(--accent-color);">
                            <span>Custom Sort Order <span
                                    style="font-weight:400; text-transform:none;">(optional)</span></span>
                        </label>
                        <div id="sort_order_panel" style="display: none; margin-top: 0.6rem;">
                            <select id="sort_order">
                                <option value="">None (filesystem order)</option>
                                <option value="imdb_list_order">ğŸ“‹ IMDb List Order</option>
                                <option value="trakt_list_order">ğŸ“‹ Trakt List Order</option>
                                <option value="tmdb_list_order">ğŸï¸ TMDb List Order</option>
                                <option value="anilist_list_order">ğŸ¨ AniList List Order</option>
                                <option value="mal_list_order">ğŸ“‹ MyAnimeList List Order</option>
                                <option value="letterboxd_list_order">ğŸ“‹ Letterboxd List Order</option>
                                <option value="CommunityRating">â­ Community Rating (highest first)</option>
                                <option value="ProductionYear">ğŸ“… Production Year (newest first)</option>
                                <option value="SortName">ğŸ”¤ Name (A â†’ Z)</option>
                                <option value="DateCreated">ğŸ• Date Added (newest first)</option>
                                <option value="Random">ğŸ² Random</option>
                            </select>
                            <small>Symlinks are named <code>0001 - Title</code>, <code>0002 - Title</code>â€¦ reflecting
                                this order.</small>
                        </div>
                    </div>

                    <!-- Individual Schedule -->
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="schedule_enabled" onchange="toggleGroupScheduler(this)"
                                style="width:14px;height:14px;accent-color:var(--accent-color);">
                            <span>Individual Sync Schedule <span
                                    style="font-weight:400; text-transform:none;">(optional)</span></span>
                        </label>
                        <div id="group_scheduler_panel" style="display: none; margin-top: 0.6rem;">
                            <input type="text" id="group_schedule" placeholder="0 12 * * * (Every day at noon)">
                            <small>Leave empty to use only the global schedule.</small>
                        </div>
                    </div>

                    <!-- Seasonal Grouping -->
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="seasonal_enabled" onchange="toggleSeasonal(this)"
                                style="width:14px;height:14px;accent-color:var(--accent-color);">
                            <span>Seasonal Grouping <span
                                    style="font-weight:400; text-transform:none;">(optional)</span></span>
                        </label>
                        <div id="seasonal_panel" style="display: none; margin-top: 0.6rem;">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.68rem; margin-bottom: 0.25rem;">Show From</label>
                                    <div style="display: flex; gap: 0.3rem;">
                                        <select id="seasonal_start_month"
                                            style="flex: 2; padding: 0.45rem; font-size: 0.82rem;">
                                            <option value="01">Jan</option>
                                            <option value="02">Feb</option>
                                            <option value="03">Mar</option>
                                            <option value="04">Apr</option>
                                            <option value="05">May</option>
                                            <option value="06">Jun</option>
                                            <option value="07">Jul</option>
                                            <option value="08">Aug</option>
                                            <option value="09">Sep</option>
                                            <option value="10">Oct</option>
                                            <option value="11">Nov</option>
                                            <option value="12">Dec</option>
                                        </select>
                                        <select id="seasonal_start_day"
                                            style="flex: 1; padding: 0.45rem; font-size: 0.82rem;"><!-- JS populated --></select>
                                    </div>
                                </div>
                                <div style="color: var(--text-secondary); padding-top: 1rem; flex-shrink:0;">to</div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.68rem; margin-bottom: 0.25rem;">Delete On</label>
                                    <div style="display: flex; gap: 0.3rem;">
                                        <select id="seasonal_end_month"
                                            style="flex: 2; padding: 0.45rem; font-size: 0.82rem;">
                                            <option value="01">Jan</option>
                                            <option value="02">Feb</option>
                                            <option value="03">Mar</option>
                                            <option value="04">Apr</option>
                                            <option value="05">May</option>
                                            <option value="06">Jun</option>
                                            <option value="07">Jul</option>
                                            <option value="08">Aug</option>
                                            <option value="09">Sep</option>
                                            <option value="10">Oct</option>
                                            <option value="11">Nov</option>
                                            <option value="12">Dec</option>
                                        </select>
                                        <select id="seasonal_end_day"
                                            style="flex: 1; padding: 0.45rem; font-size: 0.82rem;"><!-- JS populated --></select>
                                    </div>
                                </div>
                            </div>
                            <small style="margin-top: 0.4rem;">The grouping will only exist between these dates. E.g.
                                Dec 1st to Jan 1st.</small>
                        </div>
                    </div>

                    <div
                        style="display: flex; gap: 0.75rem; margin-top: 2rem; border-top: 1px solid var(--glass-border); padding-top: 1.5rem;">
                        <button type="button" id="cancel-edit-btn" onclick="cancelEdit()"
                            style="flex: 1; display: none; background: rgba(255,255,255,0.05); border: 1px solid var(--text-secondary); color: var(--text-primary); margin-top: 0; padding: 0.8rem;">
                            Cancel
                        </button>
                        <button type="submit" id="add-group-btn"
                            style="flex: 3; background: var(--accent-color); border: none; font-weight: 600; color: white; margin-top: 0; padding: 0.8rem;">
                            Add Grouping
                        </button>
                    </div>
                </form>
            </section>

            <!-- External API Connections -->
            <section class="card">
                <h2>External API Connections</h2>
                <p class="section-desc">Configure optional 3rd-party services to use as grouping sources.</p>

                <form id="api-config-form">
                    <div class="form-grid-2">
                        <div class="sub-panel">
                            <h3 style="font-size: 0.82rem; display:flex; align-items:center; gap:0.4rem;">ğŸ“¡ Trakt <span
                                    style="font-weight:400; color:var(--text-secondary);">(Optional)</span></h3>
                            <p style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Create
                                an app at <a href="https://trakt.tv/oauth/applications/new" target="_blank"
                                    style="color: var(--accent-color);">trakt.tv</a>.</p>
                            <label style="font-size: 0.68rem;">Trakt Client ID</label>
                            <input type="text" id="trakt_client_id" placeholder="Your Trakt API Client ID"
                                style="font-size:0.85rem; padding: 0.5rem 0.7rem;">
                        </div>
                        <div class="sub-panel">
                            <h3 style="font-size: 0.82rem; display:flex; align-items:center; gap:0.4rem;">ğŸ¬ TMDb <span
                                    style="font-weight:400; color:var(--text-secondary);">(Optional)</span></h3>
                            <p style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Get v3
                                API Key at <a href="https://www.themoviedb.org/settings/api" target="_blank"
                                    style="color: var(--accent-color);">themoviedb.org</a>.</p>
                            <label style="font-size: 0.68rem;">TMDb API Key</label>
                            <input type="text" id="tmdb_api_key" placeholder="Your TMDb API Key"
                                style="font-size:0.85rem; padding: 0.5rem 0.7rem;">
                        </div>
                        <div class="sub-panel">
                            <h3 style="font-size: 0.82rem; display:flex; align-items:center; gap:0.4rem;">ğŸ“º MyAnimeList
                                <span style="font-weight:400; color:var(--text-secondary);">(Optional)</span>
                            </h3>
                            <p style="font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Get
                                Client ID at <a href="https://myanimelist.net/apiconfig" target="_blank"
                                    style="color: var(--accent-color);">myanimelist.net</a>.</p>
                            <label style="font-size: 0.68rem;">MAL Client ID</label>
                            <input type="text" id="mal_client_id" placeholder="Your MyAnimeList API Client ID"
                                style="font-size:0.85rem; padding: 0.5rem 0.7rem;">
                        </div>
                    </div>
                    <button type="submit" id="save-apis-btn" style="margin-top: 1rem;">
                        <span class="loading-spinner"></span>
                        <span class="btn-text">Save API Keys</span>
                    </button>
                </form>
            </section>

        </main>
    </div>

    <!-- â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

    <!-- Export Modal -->
    <div id="export-modal" class="modal">
        <div class="card" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2>Export Settings</h2>
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label>What do you want to export?</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.75rem;">
                    <label
                        style="display: flex; align-items: center; gap: 0.75rem; text-transform: none; cursor: pointer; font-size: 0.9rem;">
                        <input type="radio" name="export-type" value="all" checked onchange="toggleExportSelection()">
                        Full Configuration (Settings + All Groups)
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 0.75rem; text-transform: none; cursor: pointer; font-size: 0.9rem;">
                        <input type="radio" name="export-type" value="selective" onchange="toggleExportSelection()">
                        Selected Groupings Only
                    </label>
                </div>
            </div>
            <div id="export-selection-list"
                style="display: none; border-top: 1px solid var(--glass-border); padding-top: 1rem; margin-bottom: 1.25rem;">
                <label>Select Groups</label>
                <div id="export-groups-container"></div>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="execExport()" style="flex: 2; margin-top:0;">Download Export</button>
                <button onclick="closeModal('export-modal')" class="secondary-btn"
                    style="flex: 1; border-color: var(--error-color); color: var(--error-color); margin-top:0;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="card" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2>Import Settings</h2>
            <div id="import-step-1">
                <p style="color: var(--text-secondary); margin-bottom: 1.25rem; font-size: 0.9rem;">Select a file to
                    begin the import process.</p>
                <button onclick="document.getElementById('import-file-input').click()"
                    style="width: 100%; margin-top:0;">Select JSON File</button>
                <input type="file" id="import-file-input" style="display: none;" accept=".json"
                    onchange="handleFileSelected(event)">
            </div>
            <div id="import-step-2" style="display: none;">
                <div id="import-warning" class="status-msg error" style="margin-bottom: 1.25rem; display: none;">
                    WARNING: This will overwrite your entire current configuration!</div>
                <div id="import-selection-list">
                    <label>Select items to import</label>
                    <div id="import-groups-container" style="margin-top: 0.5rem;"></div>
                </div>
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button id="confirm-import" style="flex: 2; margin-top:0;">Confirm Import</button>
                    <button onclick="closeModal('import-modal')" class="secondary-btn"
                        style="flex: 1; margin-top:0;">Cancel</button>
                </div>
            </div>
            <button id="cancel-import-top" onclick="closeModal('import-modal')" class="secondary-btn"
                style="margin-top: 1.25rem; width: 100%;">Cancel</button>
        </div>
    </div>

    <!-- Preview Sync Modal -->
    <div id="preview-sync-modal" class="modal">
        <div class="card"
            style="max-width: 700px; width: 90%; max-height: 85vh; display: flex; flex-direction: column;">
            <h2>Preview Sync</h2>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">This is a dry-run. No
                files or folders will be created on disk.</p>
            <div id="preview-sync-results"
                style="flex: 1; overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 1rem;">
            </div>
            <div style="display: flex; gap: 0.75rem; margin-top: auto;">
                <button onclick="closeModal('preview-sync-modal')" class="secondary-btn"
                    style="flex: 1; width: 100%; margin-top:0;">Close</button>
            </div>
        </div>
    </div>

    <!-- Cleanup Modal -->
    <div id="cleanup-modal" class="modal">
        <div class="card"
            style="max-width: 500px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
            <h2>Clean Up Folders</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.25rem; font-size: 0.85rem;">Select the folders you
                want to delete from the target directory.</p>
            <div id="cleanup-loading" style="display: flex; justify-content: center; padding: 2rem;">
                <div class="loading-spinner" style="border-top-color: var(--accent-color); display: block;"></div>
            </div>
            <div id="cleanup-error" class="status-msg error" style="display: none; margin-bottom: 1rem;"></div>
            <div id="cleanup-content" style="display: none; flex: 1; min-height: 0; flex-direction: column;">
                <div id="cleanup-list"
                    style="border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 0.5rem; overflow-y: auto; margin-bottom: 1.25rem; background: rgba(0,0,0,0.2);">
                </div>
                <div style="display: flex; gap: 0.75rem; margin-top: auto;">
                    <button id="confirm-cleanup-btn" onclick="execCleanup()"
                        style="flex: 2; background: var(--error-color); border-color: var(--error-color); margin-top:0;">Delete
                        Selected <span id="cleanup-count"></span></button>
                    <button onclick="closeModal('cleanup-modal')" class="secondary-btn"
                        style="flex: 1; margin-top:0;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Generator Modal -->
    <div id="cover-generator-modal" class="modal" style="z-index: 2000;">
        <div class="card"
            style="max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <h2>ğŸ¨ Generate Cover (16:9)</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1.25rem; margin-bottom: 1.25rem;">
                <!-- Row 1: Text -->
                <div style="grid-column: span 3;">
                    <label for="cover-text"
                        style="font-size: 0.72rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; display: block;">Cover
                        Text</label>
                    <input type="text" id="cover-text" oninput="renderCover()" placeholder="Enter group name...">
                </div>
                <!-- Row 2: Style -->
                <div style="min-width: 0;">
                    <label for="cover-theme"
                        style="font-size: 0.72rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; display: block;">Theme</label>
                    <select id="cover-theme" onchange="renderCover()">
                        <option value="modern-dark">Dark Gradient (Modern)</option>
                        <option value="vibrant-glow">Vibrant Glow</option>
                        <option value="minimal-glass">Minimal Glassmorphism</option>
                        <option value="cyberpunk">Cyberpunk Night</option>
                        <option value="aurora">Aurora Borealis</option>
                        <option value="monochrome">Monochrome Peak</option>
                        <option value="vintage">Golden Age</option>
                    </select>
                </div>
                <div style="min-width: 0;">
                    <label for="cover-border-style"
                        style="font-size: 0.72rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; display: block;">Border
                        Style</label>
                    <select id="cover-border-style" onchange="renderCover()">
                        <option value="none">None</option>
                        <option value="elegant">Elegant Thin</option>
                        <option value="bold-frame">Bold Frame</option>
                        <option value="neon-glow">Neon Glow</option>
                        <option value="tech-corners">Sci-Fi Corners</option>
                        <option value="double-inset">Double Inset</option>
                        <option value="corner-brackets">Corner Brackets</option>
                        <option value="industrial-dash">Dashed Industrial</option>
                        <option value="ornate">Ornate Frame</option>
                    </select>
                </div>
                <div
                    style="display: flex; gap: 0.6rem; align-items: flex-end; background: rgba(255,255,255,0.03); padding: 0.4rem 0.6rem; border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                    <div>
                        <label for="cover-border-color"
                            style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.25rem; display: block;">Border</label>
                        <input type="color" id="cover-border-color" value="#ffffff" onchange="renderCover()"
                            style="width: 44px; height: 32px; padding: 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; background: transparent;">
                    </div>
                    <div>
                        <label for="cover-color-1"
                            style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.25rem; display: block;">Color
                            1</label>
                        <input type="color" id="cover-color-1" value="#4f46e5" onchange="renderCover()"
                            style="width: 44px; height: 32px; padding: 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; background: transparent;">
                    </div>
                    <div>
                        <label for="cover-color-2"
                            style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.25rem; display: block;">Color
                            2</label>
                        <input type="color" id="cover-color-2" value="#9333ea" onchange="renderCover()"
                            style="width: 44px; height: 32px; padding: 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; background: transparent;">
                    </div>
                </div>
            </div>
            <div
                style="flex: 1; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.3); border-radius: var(--radius-md); padding: 1rem; overflow: hidden; border: 1px dashed var(--glass-border); min-height: 300px;">
                <canvas id="cover-canvas" width="1920" height="1080"
                    style="max-width: 100%; max-height: 45vh; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"></canvas>
            </div>
            <div style="display: flex; gap: 0.75rem; margin-top: 1.25rem;">
                <button type="button" onclick="applyCover()" style="flex: 2; font-weight: 600; margin-top:0;">Apply
                    Cover</button>
                <button type="button" onclick="downloadCover()" class="secondary-btn"
                    style="flex: 1; font-weight: 600; margin-top:0;">Download</button>
                <button type="button" onclick="closeModal('cover-generator-modal')" class="secondary-btn"
                    style="flex: 1; margin-top:0;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Global Status Toast -->
    <div id="status-msg" class="status-msg"></div>

    <!-- Folder Picker Modal -->
    <div id="path-picker-modal" onclick="pickerOutsideClick(event)">
        <div class="picker-box">
            <div class="picker-header">
                <div class="picker-title" id="picker-title">Select Folder</div>
                <div class="picker-breadcrumb" id="picker-breadcrumb">/</div>
            </div>
            <div class="picker-body" id="picker-body"></div>
            <div class="picker-footer">
                <span class="picker-footer-path" id="picker-footer-path">No folder selected</span>
                <button onclick="closePicker()" class="secondary-btn"
                    style="width:auto;padding:0.5rem 1rem;margin:0;">Cancel</button>
                <button onclick="confirmPicker()" style="width:auto;padding:0.5rem 1rem;margin:0;">Select</button>
            </div>
        </div>
    </div>

    <script>
        const configForm = document.getElementById('config-form');
        const apiConfigForm = document.getElementById('api-config-form');
        const groupForm = document.getElementById('group-form');
        const groupFormTitle = document.getElementById('group-form-title');
        const addGroupBtn = document.getElementById('add-group-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveBtn = document.getElementById('save-btn');
        const saveApisBtn = document.getElementById('save-apis-btn');
        const testBtn = document.getElementById('test-btn');
        const statusMsg = document.getElementById('status-msg');
        const groupsList = document.getElementById('groups-list');

        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const maintenanceCard = document.getElementById('maintenance-card');
        const groupingsSection = document.getElementById('groupings-section');

        const sourceValueInput = document.getElementById('source_value');
        const sourceValueSelect = document.getElementById('source_value_select');
        const sourceValueHelp = document.getElementById('source_value_help');

        const sourceOptions = {
            jellyfin: [
                { value: 'general', label: 'General (Title, Date, Rating...)' },
                { value: 'genre', label: 'Genre' },
                { value: 'actor', label: 'Actor' },
                { value: 'studio', label: 'Studio' },
                { value: 'tag', label: 'Jellyfin Tag' },
                { value: 'complex', label: 'Complex Rule-set (Mixed)' }
            ],
            external: [
                { value: 'imdb_list', label: 'IMDb List' },
                { value: 'trakt_list', label: 'Trakt List', requiredKey: 'trakt_client_id' },
                { value: 'tmdb_list', label: 'TMDb List', requiredKey: 'tmdb_api_key' },
                { value: 'anilist_list', label: 'AniList List' },
                { value: 'mal_list', label: 'MyAnimeList List', requiredKey: 'mal_client_id' },
                { value: 'letterboxd_list', label: 'Letterboxd List' }
            ]
        };

        const metadataTypes = ['genre', 'actor', 'studio', 'tag', 'complex'];

        let currentConfig = { groups: [] };
        let pendingImportData = null;
        let editingIndex = -1;
        let isServerValidated = false;
        let cachedMetadata = {};
        let lastRenderedType = null;
        window._currentMetadataRules = [{ operator: '', value: '' }];

        function getFilterValue() {
            const type = document.getElementById('source_type').value;
            const isMetadataType = metadataTypes.includes(type);
            if (isMetadataType && isServerValidated) {
                const validRules = window._currentMetadataRules.filter(r => r.value && r.value.trim() !== '');
                if (validRules.length === 0) return '';
                const parts = validRules.map((r, i) => {
                    const prefix = type === 'complex' ? `${r.type || 'genre'}:` : '';
                    return i === 0 ? `${prefix}${r.value.trim()}` : `${r.operator} ${prefix}${r.value.trim()}`;
                });
                return parts.join(' ');
            }
            return document.getElementById('source_value').value.trim();
        }

        function parseMetadataValue(valStr) {
            if (!valStr || valStr.trim() === '') return [{ operator: '', value: '' }];
            const pattern = /\s+(AND NOT|OR NOT|AND|OR)\s+/i;
            const parts = valStr.split(pattern);
            const rules = [];

            const parseRule = (s) => {
                const match = s.trim().match(/^(\w+):(.+)$/);
                if (match) return { type: match[1], value: match[2].trim() };
                return { value: s.trim() };
            };

            const first = parseRule(parts[0]);
            rules.push({ operator: '', ...first });

            for (let i = 1; i < parts.length; i += 2) {
                const rest = parseRule(parts[i + 1]);
                rules.push({ operator: parts[i].trim().toUpperCase().replace(/\s+/g, ' '), ...rest });
            }
            return rules;
        }

        function renderMetadataRules() {
            const container = document.getElementById('metadata_rules_container');
            container.innerHTML = '';
            const type = document.getElementById('source_type').value;

            window._currentMetadataRules.forEach((rule, index) => {
                const row = document.createElement('div');
                row.setAttribute('style', 'display: flex; gap: 0.5rem; align-items: center; width: 100%;');

                if (index > 0) {
                    const opSelect = document.createElement('select');
                    opSelect.setAttribute('style', 'flex: 0 0 auto; padding: 0.8rem; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.9rem; font-weight: 600;');
                    const ops = ['AND', 'OR', 'AND NOT', 'OR NOT'];
                    ops.forEach(op => {
                        const o = document.createElement('option');
                        o.value = op;
                        o.textContent = op;
                        if (rule.operator === op) o.selected = true;
                        opSelect.appendChild(o);
                    });
                    opSelect.onchange = (e) => { rule.operator = e.target.value; };
                    row.appendChild(opSelect);
                }

                if (type === 'complex') {
                    const rowTypeSelect = document.createElement('select');
                    rowTypeSelect.setAttribute('style', 'flex: 0 0 auto; width: 110px; padding: 0.8rem; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.9rem;');
                    const types = ['genre', 'actor', 'studio', 'tag'];
                    types.forEach(t => {
                        const o = document.createElement('option');
                        o.value = t;
                        o.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                        if (rule.type === t || (!rule.type && t === 'genre')) o.selected = true;
                        if (!rule.type) rule.type = 'genre';
                        rowTypeSelect.appendChild(o);
                    });
                    rowTypeSelect.onchange = (e) => {
                        rule.type = e.target.value;
                        renderMetadataRules();
                    };
                    row.appendChild(rowTypeSelect);
                }

                const rowType = type === 'complex' ? (rule.type || 'genre') : type;
                const options = cachedMetadata[rowType] || [];

                const valSelect = document.createElement('select');
                valSelect.setAttribute('style', 'flex: 1; padding: 0.8rem 1rem; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 1rem;');

                const defaultOpt = document.createElement('option');
                defaultOpt.value = '';
                defaultOpt.textContent = 'Select ' + rowType + '...';
                defaultOpt.disabled = true;
                defaultOpt.selected = !rule.value;
                valSelect.appendChild(defaultOpt);

                let foundMatch = false;
                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt;
                    o.textContent = opt;
                    if (rule.value === opt) { o.selected = true; foundMatch = true; }
                    valSelect.appendChild(o);
                });

                if (rule.value && !foundMatch) {
                    const o = document.createElement('option');
                    o.value = rule.value;
                    o.textContent = rule.value + " (Unavailable/Custom)";
                    o.selected = true;
                    valSelect.appendChild(o);
                }

                valSelect.onchange = (e) => { rule.value = e.target.value; };
                row.appendChild(valSelect);

                if (index > 0) {
                    const rmBtn = document.createElement('button');
                    rmBtn.type = 'button';
                    rmBtn.innerHTML = '<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
                    rmBtn.className = 'delete-btn';
                    rmBtn.title = 'Remove condition';
                    rmBtn.setAttribute('style', 'padding: 0; width: 38px; height: 38px; display:flex; align-items:center; justify-content:center; margin: 0; flex-shrink: 0;');
                    rmBtn.onclick = () => {
                        window._currentMetadataRules.splice(index, 1);
                        renderMetadataRules();
                    };
                    row.appendChild(rmBtn);
                }

                container.appendChild(row);
            });
        }

        function toggleGlobalScheduler(cb) {
            const panel = document.getElementById('global_scheduler_panel');
            if (panel) panel.style.display = cb.checked ? 'block' : 'none';
        }

        function toggleCleanupScheduler(cb) {
            const panel = document.getElementById('cleanup_scheduler_panel');
            if (panel) panel.style.display = cb.checked ? 'block' : 'none';
        }

        function toggleGroupScheduler(cb) {
            const panel = document.getElementById('group_scheduler_panel');
            if (panel) panel.style.display = cb.checked ? 'block' : 'none';
        }

        function updateGlobalSyncExclusionsUI() {
            const container = document.getElementById('global_sync_exclusions');
            if (!container) return;
            container.innerHTML = '';

            if (!currentConfig.scheduler) {
                currentConfig.scheduler = { global_enabled: false, global_schedule: '', global_exclude_ids: [] };
            }
            if (!currentConfig.scheduler.global_exclude_ids) {
                currentConfig.scheduler.global_exclude_ids = [];
            }

            // Prune stale group names from global_exclude_ids
            const validGroupNames = currentConfig.groups.map(g => g.name).filter(Boolean);
            currentConfig.scheduler.global_exclude_ids = currentConfig.scheduler.global_exclude_ids.filter(id => validGroupNames.includes(id));

            const excludedIds = currentConfig.scheduler.global_exclude_ids;

            currentConfig.groups.forEach((group) => {
                if (!group.name) return;
                const label = document.createElement('label');
                label.setAttribute('style', 'display: flex; align-items: center; gap: 0.6rem; cursor: pointer; font-size: 0.85rem; padding: 0.2rem 0;');

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = excludedIds.includes(group.name);
                cb.setAttribute('style', 'width:16px; height:16px; accent-color: var(--accent-color);');
                cb.onchange = (e) => {
                    const idx = excludedIds.indexOf(group.name);
                    if (e.target.checked) {
                        if (idx === -1) excludedIds.push(group.name);
                    } else {
                        if (idx !== -1) excludedIds.splice(idx, 1);
                    }
                };

                label.appendChild(cb);
                label.appendChild(document.createTextNode(group.name));
                container.appendChild(label);
            });

            if (currentConfig.groups.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.8rem; font-style: italic;">No groups defined yet.</p>';
            }
        }

        function addMetadataRule() {
            window._currentMetadataRules.push({ operator: 'AND', value: '' });
            renderMetadataRules();
        }

        async function previewGrouping() {
            const type = document.getElementById('source_type').value;
            const val = getFilterValue();
            const resultDiv = document.getElementById('preview_result');

            if (!metadataTypes.includes(type) && type !== 'general') {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span style="color:var(--text-secondary);">Preview mostly supports Jellyfin library metadata types (Genre, Actor, etc). Try connecting server or checking other logs.</span>';
                return;
            }

            if (!val) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span style="color:var(--error-color);">Please enter a filter value to preview.</span>';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading-spinner" style="display:inline-block; margin-right: 0.5rem; border-color: rgba(255,255,255,0.2); border-left-color: var(--accent-color);"></span> <span style="color: var(--text-secondary);">Loading preview...</span>';

            try {
                const response = await fetch('/api/grouping/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, value: val, watch_state: document.getElementById('watch_state').value })
                });
                const res = await response.json();
                resultDiv.innerHTML = '';
                if (res.status === 'success') {
                    const summaryLine = document.createElement('div');
                    const labelStrong = document.createElement('strong');
                    labelStrong.setAttribute('style', 'color:var(--text-primary);');
                    labelStrong.textContent = 'Estimated Items: ';
                    const countSpan = document.createElement('span');
                    countSpan.setAttribute('style', 'color:var(--accent-color); font-weight:600;');
                    countSpan.textContent = String(res.count);
                    summaryLine.appendChild(labelStrong);
                    summaryLine.appendChild(countSpan);
                    resultDiv.appendChild(summaryLine);

                    if (res.count > 0) {
                        const matchesLabel = document.createElement('strong');
                        matchesLabel.textContent = 'First matches:';
                        matchesLabel.setAttribute('style', 'display:block; margin-top:0.6rem;');
                        resultDiv.appendChild(matchesLabel);

                        const ul = document.createElement('ul');
                        ul.setAttribute('style', 'margin-top:0.4rem; padding-left:1.5rem; color:var(--text-secondary);');
                        res.preview_items.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item.Year ? `${item.Name} (${item.Year})` : item.Name;
                            ul.appendChild(li);
                        });
                        resultDiv.appendChild(ul);
                    }
                } else {
                    const errSpan = document.createElement('span');
                    errSpan.setAttribute('style', 'color:var(--error-color);');
                    errSpan.textContent = `Error: ${res.message}`;
                    resultDiv.appendChild(errSpan);
                }
            } catch (e) {
                resultDiv.innerHTML = '<span style="color:var(--error-color);">Network error during preview.</span>';
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                currentConfig = await response.json();
                currentConfig.groups = currentConfig.groups || [];

                // Backwards compatibility / Data Migration
                currentConfig.groups.forEach(g => {
                    if (!g.source_category) {
                        if (['imdb_list', 'trakt_list'].includes(g.source_type)) {
                            g.source_category = 'external';
                        } else {
                            g.source_category = 'jellyfin';
                            if (g.source_type === 'jellyfin_tag') g.source_type = 'tag';
                            if (g.source_type === 'people') g.source_type = 'actor';
                        }
                    } else if (g.source_type === 'people') {
                        // Handle cases where category was set but type was still old
                        g.source_type = 'actor';
                    }
                });

                document.getElementById('jellyfin_url').value = currentConfig.jellyfin_url || '';
                document.getElementById('api_key').value = currentConfig.api_key || '';
                document.getElementById('target_path').value = currentConfig.target_path || '';
                document.getElementById('media_path_in_jellyfin').value = currentConfig.media_path_in_jellyfin || currentConfig.jellyfin_root || '';
                document.getElementById('media_path_on_host').value = currentConfig.media_path_on_host || currentConfig.host_root || '';
                document.getElementById('trakt_client_id').value = currentConfig.trakt_client_id || '';
                document.getElementById('tmdb_api_key').value = currentConfig.tmdb_api_key || '';
                document.getElementById('mal_client_id').value = currentConfig.mal_client_id || '';

                document.getElementById('auto_create_libraries').checked = !!currentConfig.auto_create_libraries;
                document.getElementById('auto_set_library_covers').checked = !!currentConfig.auto_set_library_covers;
                document.getElementById('target_path_in_jellyfin').value = currentConfig.target_path_in_jellyfin || '';

                // Scheduler settings
                const sched = currentConfig.scheduler || { global_enabled: false, global_schedule: '', global_exclude_ids: [], cleanup_enabled: true, cleanup_schedule: '0 * * * *' };
                document.getElementById('global_scheduler_enabled').checked = sched.global_enabled;
                document.getElementById('global_sync_schedule').value = sched.global_schedule || '';
                toggleGlobalScheduler(document.getElementById('global_scheduler_enabled'));

                document.getElementById('cleanup_scheduler_enabled').checked = sched.cleanup_enabled !== false; // Default true
                document.getElementById('cleanup_sync_schedule').value = sched.cleanup_schedule || '0 * * * *';
                toggleCleanupScheduler(document.getElementById('cleanup_scheduler_enabled'));

                updateSourceTypeOptions();
                renderGroups();

                // Initial silent test if we have config
                if (currentConfig.jellyfin_url && currentConfig.api_key) {
                    await performSilentTest();
                }
            } catch (err) {
                showStatus('Failed to load configuration', 'error');
            }
        }

        async function performSilentTest() {
            const data = {
                jellyfin_url: currentConfig.jellyfin_url,
                api_key: currentConfig.api_key
            };
            try {
                const response = await fetch('/api/test-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                const isValid = result.status === 'success';
                updateValidationUI(isValid);
                if (isValid) refreshMetadata();
            } catch (err) {
                updateValidationUI(false);
            }
        }

        async function testConnection() {
            testBtn.classList.add('btn-loading');
            const data = {
                jellyfin_url: document.getElementById('jellyfin_url').value,
                api_key: document.getElementById('api_key').value
            };

            try {
                const response = await fetch('/api/test-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    updateValidationUI(true);
                    // Also save if successful to lock in the working settings
                    currentConfig.jellyfin_url = data.jellyfin_url;
                    currentConfig.api_key = data.api_key;
                    currentConfig.target_path = document.getElementById('target_path').value;
                    await saveAllConfig();
                    await refreshMetadata();
                    // Auto-detect paths only if fields are currently empty
                    await autoDetectIfEmpty();
                } else {
                    showStatus(result.message || 'Connection failed', 'error');
                    updateValidationUI(false);
                }
            } catch (err) {
                showStatus('Connection test failed - API unreachable', 'error');
                updateValidationUI(false);
            } finally {
                testBtn.classList.remove('btn-loading');
            }
        }

        async function refreshMetadata() {
            try {
                // We've deleted the old `<select>`, no loading state required. Data populates into the dropdown silently
                const response = await fetch('/api/jellyfin/metadata');
                const result = await response.json();
                if (result.status === 'success') {
                    cachedMetadata = result.metadata;
                    updateSourceValueUI();
                } else {
                    console.error('Failed to load metadata from Jellyfin server');
                }
            } catch (err) {
                console.error('Failed to fetch metadata:', err);
            }
        }

        function updateSourceTypeOptions() {
            const category = document.getElementById('source_category').value;
            const typeSelect = document.getElementById('source_type');
            const currentValue = typeSelect.value;

            typeSelect.innerHTML = '';
            sourceOptions[category].forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value;

                // Check if this option requires an API key that is currently missing
                let isDisabled = false;
                if (opt.requiredKey && (!currentConfig[opt.requiredKey] || currentConfig[opt.requiredKey].trim() === '')) {
                    isDisabled = true;
                }

                if (isDisabled) {
                    o.textContent = `${opt.label} (Keys missing - see Server Settings)`;
                    o.disabled = true;
                } else {
                    o.textContent = opt.label;
                }

                typeSelect.appendChild(o);
            });

            // Keep selection if possible and not disabled
            const validOptions = Array.from(typeSelect.options).filter(opt => !opt.disabled).map(opt => opt.value);
            if (validOptions.includes(currentValue)) {
                typeSelect.value = currentValue;
            } else if (validOptions.length > 0) {
                typeSelect.value = validOptions[0];
            }

            // Always update source value UI when type header changes
            updateSourceValueUI();
        }

        function updateSourceValueUI(preValue = null) {
            const type = document.getElementById('source_type').value;
            const isMetadataType = metadataTypes.includes(type);

            const container = document.getElementById('metadata_rules_container');
            const addBtn = document.getElementById('add-rule-btn');

            // Hide old select logic, always use text input
            sourceValueInput.style.display = 'block';
            sourceValueInput.required = true;
            sourceValueInput.disabled = false;

            const datalist = document.getElementById('source_value_datalist');

            if (isMetadataType) {
                sourceValueHelp.style.display = 'block';

                if (isServerValidated) {
                    datalist.innerHTML = '';
                    sourceValueInput.style.display = 'none';
                    sourceValueInput.required = false;
                    container.style.display = 'flex';
                    addBtn.style.display = 'inline-block';

                    if (type !== lastRenderedType || preValue) {
                        if (preValue) {
                            window._currentMetadataRules = parseMetadataValue(preValue);
                        } else {
                            window._currentMetadataRules = [{ operator: '', value: '' }];
                        }
                        lastRenderedType = type;
                    }
                    renderMetadataRules();

                    sourceValueHelp.textContent = `Select one or more ${type}s from your Jellyfin server. Use + to combine logic operators.`;
                } else {
                    datalist.innerHTML = '';
                    container.style.display = 'none';
                    addBtn.style.display = 'none';
                    sourceValueHelp.innerHTML = `You must connect your Jellyfin server to see autocompletion. You can manually type a complex filter (e.g. <code>Horror AND Action AND NOT Comedy</code>).`;
                    if (preValue) sourceValueInput.value = preValue;
                }
            } else {
                datalist.innerHTML = '';
                container.style.display = 'none';
                addBtn.style.display = 'none';
                if (preValue) sourceValueInput.value = preValue;
                if (type === 'imdb_list') {
                    sourceValueInput.placeholder = 'e.g. ls000024390 or full IMDb list URL';
                    sourceValueHelp.innerHTML = 'Enter the IMDb list ID (e.g. <code>ls000024390</code>) or paste the full URL â€” the ID will be extracted automatically.';
                } else if (type === 'trakt_list') {
                    sourceValueInput.placeholder = 'https://trakt.tv/users/username/lists/list-slug';
                    sourceValueHelp.innerHTML = 'Paste the full Trakt list URL. Requires a <strong>Trakt Client ID</strong> in Server Settings. Matches by IMDb ID against your Jellyfin library.';
                } else if (type === 'tmdb_list') {
                    sourceValueInput.placeholder = 'e.g. 12345 or full TMDb list URL';
                    sourceValueHelp.innerHTML = 'Enter the TMDb list ID or paste the full URL. Matches by TMDb ID against your Jellyfin library.';
                } else if (type === 'anilist_list') {
                    sourceValueInput.placeholder = 'e.g. username  or  username/PLANNING';
                    sourceValueHelp.innerHTML = 'Enter your AniList username (e.g. <code>username</code>) or username and status (e.g. <code>username/PLANNING</code>). Matches by AniList ID against your Jellyfin library.';
                } else if (type === 'mal_list') {
                    sourceValueInput.placeholder = 'e.g. username or username/plan_to_watch';
                    sourceValueHelp.innerHTML = 'Enter your MAL username (e.g. <code>username</code>) or username and status (e.g. <code>username/plan_to_watch</code>). Matches by MAL ID against your Jellyfin library.';
                } else if (type === 'general') {
                    sourceValueInput.placeholder = 'e.g. Action  or  tt1234567';
                    sourceValueHelp.textContent = 'Enter item name or date range.';
                } else {
                    sourceValueInput.placeholder = 'e.g. Action  or  ls000024390';
                    sourceValueHelp.textContent = 'Enter the ID or Value manually.';
                }
            }
        }

        function updateValidationUI(isValid) {
            isServerValidated = isValid;

            const pathFieldIds = ['target_path', 'media_path_in_jellyfin', 'media_path_on_host', 'target_path_in_jellyfin'];
            const pathGroupIds = ['target_path_group', 'media_path_in_jellyfin_group', 'media_path_on_host_group', 'target_path_in_jellyfin_group'];

            const schedulerCard = document.getElementById('scheduler-card');

            if (isValid) {
                statusDot.className = 'connection-dot online';
                statusText.textContent = 'Connected';
                maintenanceCard.classList.remove('locked-section');
                groupingsSection.classList.remove('locked-section');
                if (schedulerCard) schedulerCard.classList.remove('locked-section');
                // Unlock path fields
                pathFieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = false;
                });
                pathGroupIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('path-field-locked');
                        el.querySelectorAll('button').forEach(b => b.disabled = false);
                    }
                });
            } else {
                statusDot.className = 'connection-dot offline';
                statusText.textContent = 'Disconnected';
                maintenanceCard.classList.add('locked-section');
                groupingsSection.classList.add('locked-section');
                if (schedulerCard) schedulerCard.classList.add('locked-section');
                // Lock path fields
                pathFieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = true;
                });
                pathGroupIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.add('path-field-locked');
                        el.querySelectorAll('button').forEach(b => b.disabled = true);
                    }
                });
            }
            updateSourceTypeOptions();
        }

        function renderGroups() {
            groupsList.innerHTML = '';
            if (!currentConfig.groups || currentConfig.groups.length === 0) {
                groupsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-style: italic; margin-top: 2rem;">No groupings defined yet.</p>';
                updateGlobalSyncExclusionsUI();
                return;
            }

            updateGlobalSyncExclusionsUI();

            currentConfig.groups.forEach((group, index) => {
                const card = document.createElement('div');
                card.className = 'group-card';

                const catLabel = group.source_category === 'external' ? 'External' : 'Jellyfin';
                const typeLabel = sourceOptions[group.source_category]?.find(opt => opt.value === group.source_type)?.label || group.source_type;

                const sortLabels = {
                    'imdb_list_order': 'ğŸ“‹ IMDb List Order',
                    'trakt_list_order': 'ğŸ“‹ Trakt List Order',
                    'tmdb_list_order': 'ğŸï¸ TMDb List Order',
                    'anilist_list_order': 'ğŸ¨ AniList List Order',
                    'mal_list_order': 'ğŸ“‹ MAL List Order',
                    'CommunityRating': 'â­ Community Rating',
                    'ProductionYear': 'ğŸ“… Production Year',
                    'SortName': 'ğŸ”¤ Name (Aâ†’Z)',
                    'DateCreated': 'ğŸ• Date Added',
                    'Random': 'ğŸ² Random',
                };

                const infoDiv = document.createElement('div');
                infoDiv.className = 'group-info';

                const h4 = document.createElement('h4');
                h4.textContent = group.name || 'Unnamed Group';
                if (group.sort_order) {
                    const badge = document.createElement('span');
                    badge.setAttribute('style', 'display:inline-block; margin-left:0.5rem; font-size:0.72rem; background:rgba(99,102,241,0.15); color:var(--accent-color); border:1px solid rgba(99,102,241,0.3); border-radius:4px; padding:0.1rem 0.4rem;');
                    badge.textContent = sortLabels[group.sort_order] || group.sort_order;
                    h4.appendChild(badge);
                }
                if (group.seasonal_enabled) {
                    const badge = document.createElement('span');
                    badge.setAttribute('style', 'display:inline-block; margin-left:0.5rem; font-size:0.72rem; background:rgba(245,158,11,0.15); color:var(--warning-color); border:1px solid rgba(245,158,11,0.3); border-radius:4px; padding:0.1rem 0.4rem;');
                    badge.textContent = `ğŸ“… ${group.seasonal_start} to ${group.seasonal_end}`;
                    h4.appendChild(badge);
                }
                infoDiv.appendChild(h4);

                const metaDiv = document.createElement('div');
                metaDiv.className = 'group-meta';
                const catSpan = document.createElement('span');
                catSpan.setAttribute('style', 'color: var(--accent-color); font-weight: 600;');
                catSpan.textContent = catLabel;
                metaDiv.appendChild(catSpan);
                metaDiv.appendChild(document.createTextNode(` \u2022 ${typeLabel}: ${group.source_value || ''}`));
                infoDiv.appendChild(metaDiv);
                card.appendChild(infoDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'group-actions';

                const coverBtn = document.createElement('button');
                coverBtn.className = 'secondary-btn';
                coverBtn.title = 'Group Cover';
                coverBtn.setAttribute('style', 'padding: 0.5rem 0.8rem; font-size: 0.8rem; margin: 0; width: auto; border: 1px dashed var(--accent-color); color: var(--accent-color);');
                coverBtn.textContent = 'ğŸ¨ Cover';
                coverBtn.onclick = () => openCoverGenerator(index);
                actionsDiv.appendChild(coverBtn);

                const editBtn = document.createElement('button');
                editBtn.className = 'secondary-btn';
                editBtn.title = 'Edit Group';
                editBtn.setAttribute('style', 'padding: 0.5rem 0.8rem; font-size: 0.8rem; margin: 0; width: auto; border-color: var(--accent-color); color: var(--accent-color);');
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editGroup(index);
                actionsDiv.appendChild(editBtn);

                const delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.title = 'Remove Group';
                delBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>';
                delBtn.appendChild(document.createTextNode(' Remove'));
                delBtn.onclick = () => deleteGroup(index);
                actionsDiv.appendChild(delBtn);

                card.appendChild(actionsDiv);
                groupsList.appendChild(card);
            });
        }

        async function saveAllConfig() {
            // Update global scheduler settings from UI before saving
            if (!currentConfig.scheduler) currentConfig.scheduler = {};
            currentConfig.scheduler.global_enabled = document.getElementById('global_scheduler_enabled').checked;
            currentConfig.scheduler.global_schedule = document.getElementById('global_sync_schedule').value.trim();

            currentConfig.scheduler.cleanup_enabled = document.getElementById('cleanup_scheduler_enabled').checked;
            currentConfig.scheduler.cleanup_schedule = document.getElementById('cleanup_sync_schedule').value.trim() || '0 * * * *';
            // global_exclude_ids is updated in real-time by checkbox event listeners in updateGlobalSyncExclusionsUI

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentConfig)
                });
                if (response.ok) {
                    showStatus('Settings saved', 'success');
                    renderGroups();
                    updateSourceTypeOptions();
                } else {
                    showStatus('Server error while saving', 'error');
                }
            } catch (err) {
                showStatus('Network error - changes not saved locally', 'error');
            }
        }

        function showStatus(msg, type) {
            statusMsg.textContent = msg;
            statusMsg.className = `status-msg ${type}`;
            statusMsg.style.display = 'block';
            setTimeout(() => { if (statusMsg.textContent === msg) statusMsg.style.display = 'none'; }, 3000);
        }

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.classList.add('btn-loading');

            currentConfig.jellyfin_url = document.getElementById('jellyfin_url').value;
            currentConfig.api_key = document.getElementById('api_key').value;
            currentConfig.target_path = document.getElementById('target_path').value;
            currentConfig.media_path_in_jellyfin = document.getElementById('media_path_in_jellyfin').value;
            currentConfig.media_path_on_host = document.getElementById('media_path_on_host').value;
            currentConfig.auto_create_libraries = document.getElementById('auto_create_libraries').checked;
            currentConfig.auto_set_library_covers = document.getElementById('auto_set_library_covers').checked;
            currentConfig.target_path_in_jellyfin = document.getElementById('target_path_in_jellyfin').value;

            await saveAllConfig();
            saveBtn.classList.remove('btn-loading');

            // Re-trigger metadata discovery after settings change
            await refreshMetadata();
        });

        apiConfigForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveApisBtn.classList.add('btn-loading');

            currentConfig.trakt_client_id = document.getElementById('trakt_client_id').value;
            currentConfig.tmdb_api_key = document.getElementById('tmdb_api_key').value;
            currentConfig.mal_client_id = document.getElementById('mal_client_id').value;

            await saveAllConfig();
            saveApisBtn.classList.remove('btn-loading');
        });

        groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const source_type = document.getElementById('source_type').value;
            const val = getFilterValue();

            if (!val) {
                showStatus('Please enter or select a filter value', 'error');
                return;
            }

            const groupData = {
                name: document.getElementById('group_name').value,
                source_category: document.getElementById('source_category').value,
                source_type: source_type,
                source_value: val,
                sort_order: document.getElementById('sort_order_enabled').checked ? (document.getElementById('sort_order').value || '') : '',
                schedule_enabled: document.getElementById('schedule_enabled').checked,
                schedule: document.getElementById('group_schedule').value.trim(),
                seasonal_enabled: document.getElementById('seasonal_enabled').checked,
                seasonal_start: `${document.getElementById('seasonal_start_month').value}-${document.getElementById('seasonal_start_day').value}`,
                seasonal_end: `${document.getElementById('seasonal_end_month').value}-${document.getElementById('seasonal_end_day').value}`,
                watch_state: document.getElementById('watch_state').value
            };

            if (metadataTypes.includes(source_type)) {
                if (typeof window._currentMetadataRules !== 'undefined' && Array.isArray(window._currentMetadataRules)) {
                    const validRules = window._currentMetadataRules.filter(r => r.value && r.value.trim() !== '');
                    if (validRules.length > 0) {
                        groupData.rules = validRules.map(r => ({
                            operator: r.operator || 'AND',
                            type: r.type || (source_type === 'complex' ? 'genre' : source_type),
                            value: r.value
                        }));
                    }
                }
            }

            if (!currentConfig.groups) currentConfig.groups = [];

            if (editingIndex >= 0) {
                currentConfig.groups[editingIndex] = groupData;
                editingIndex = -1;
            } else {
                currentConfig.groups.push(groupData);
            }

            await saveAllConfig();
            groupForm.reset();
            resetFormUI();
        });

        function editGroup(index) {
            editingIndex = index;
            const group = currentConfig.groups[index];

            document.getElementById('group_name').value = group.name;
            document.getElementById('source_category').value = group.source_category || 'jellyfin';
            updateSourceTypeOptions();
            document.getElementById('source_type').value = group.source_type;
            const hasSortOrder = !!(group.sort_order);
            document.getElementById('sort_order_enabled').checked = hasSortOrder;
            document.getElementById('sort_order_panel').style.display = hasSortOrder ? 'block' : 'none';
            document.getElementById('sort_order').value = group.sort_order || '';

            const hasSchedule = !!(group.schedule_enabled);
            document.getElementById('schedule_enabled').checked = hasSchedule;
            document.getElementById('group_scheduler_panel').style.display = hasSchedule ? 'block' : 'none';
            document.getElementById('group_schedule').value = group.schedule || '';

            const isSeasonal = !!(group.seasonal_enabled);
            document.getElementById('seasonal_enabled').checked = isSeasonal;
            document.getElementById('seasonal_panel').style.display = isSeasonal ? 'block' : 'none';
            if (group.seasonal_start) {
                const [sm, sd] = group.seasonal_start.split('-');
                document.getElementById('seasonal_start_month').value = sm;
                document.getElementById('seasonal_start_day').value = sd;
            }
            if (group.seasonal_end) {
                const [em, ed] = group.seasonal_end.split('-');
                document.getElementById('seasonal_end_month').value = em;
                document.getElementById('seasonal_end_day').value = ed;
            }
            document.getElementById('watch_state').value = group.watch_state || '';

            updateSourceValueUI(group.source_value);

            groupFormTitle.textContent = 'Edit Grouping';
            addGroupBtn.textContent = 'Update Grouping';
            cancelEditBtn.style.display = 'block';

            // Scroll form into view
            groupForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function cancelEdit() {
            editingIndex = -1;
            groupForm.reset();
            resetFormUI();
        }

        function resetFormUI() {
            groupFormTitle.textContent = 'Create New Grouping';
            addGroupBtn.textContent = 'Add Grouping';
            cancelEditBtn.style.display = 'none';
            document.getElementById('sort_order_enabled').checked = false;
            document.getElementById('sort_order_panel').style.display = 'none';
            document.getElementById('schedule_enabled').checked = false;
            document.getElementById('group_scheduler_panel').style.display = 'none';
            document.getElementById('seasonal_enabled').checked = false;
            document.getElementById('seasonal_panel').style.display = 'none';
            document.getElementById('watch_state').value = '';
            updateSourceTypeOptions();
        }

        function toggleSortOrder(checkbox) {
            document.getElementById('sort_order_panel').style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleSeasonal(checkbox) {
            document.getElementById('seasonal_panel').style.display = checkbox.checked ? 'block' : 'none';
        }

        function populateSeasonalDays() {
            const startDaySelect = document.getElementById('seasonal_start_day');
            const endDaySelect = document.getElementById('seasonal_end_day');

            [startDaySelect, endDaySelect].forEach(select => {
                select.innerHTML = '';
                for (let i = 1; i <= 31; i++) {
                    const opt = document.createElement('option');
                    const val = i.toString().padStart(2, '0');
                    opt.value = val;
                    opt.textContent = i;
                    select.appendChild(opt);
                }
            });
        }

        // Call this on load
        populateSeasonalDays();

        // --- Cover Generator Logic ---
        let activeCoverIndex = -1;

        function openCoverGenerator(index) {
            activeCoverIndex = index;
            const group = currentConfig.groups[index];

            document.getElementById('cover-text').value = group.cover_text || group.name || 'Custom Group';
            document.getElementById('cover-theme').value = group.cover_theme || 'modern-dark';
            document.getElementById('cover-border-style').value = group.cover_border_style || 'none';
            document.getElementById('cover-border-color').value = group.cover_border_color || '#ffffff';
            document.getElementById('cover-color-1').value = group.cover_color1 || '#4f46e5';
            document.getElementById('cover-color-2').value = group.cover_color2 || '#9333ea';

            document.getElementById('cover-generator-modal').style.display = 'flex';

            // Ensure fonts are ready before first render
            if (document.fonts && document.fonts.ready) {
                document.fonts.ready.then(() => renderCover());
            } else {
                setTimeout(() => renderCover(), 100);
            }
        }

        // --- Deterministic PRNG helpers ---
        function mulberry32(a) {
            return function () {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function getSeed(str) {
            let hash = 2166136261;
            for (let i = 0; i < str.length; i++) {
                hash ^= str.charCodeAt(i);
                hash = Math.imul(hash, 16777619);
            }
            return hash >>> 0;
        }

        function renderCover() {
            const canvas = document.getElementById('cover-canvas');
            const ctx = canvas.getContext('2d');
            const text = document.getElementById('cover-text').value.trim() || 'Group Name';
            const theme = document.getElementById('cover-theme').value;
            const color1 = document.getElementById('cover-color-1').value;
            const color2 = document.getElementById('cover-color-2').value;

            // Seeded random for deterministic renders
            const seed = getSeed(text + theme + color1 + color2);
            const seededRand = mulberry32(seed);

            // High-DPI Anti-Aliasing Fix
            const dpr = window.devicePixelRatio || 1;
            const logicalW = 1920;
            const logicalH = 1080;

            if (canvas.width !== logicalW * dpr) {
                canvas.width = logicalW * dpr;
                canvas.height = logicalH * dpr;
                canvas.style.width = logicalW + 'px';
                canvas.style.height = logicalH + 'px';
            }

            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            const w = logicalW;
            const h = logicalH;

            ctx.clearRect(0, 0, w, h);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            const helpers = {
                hexToRgb: (hex) => {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : { r: 0, g: 0, b: 0 };
                },
                roundRect: roundRect,
                wrapText: wrapText,
                seededRand: seededRand
            };

            const themeFunctions = {
                'modern-dark': (ctx, w, h, { color1, color2 }, hlp) => {
                    const grad = ctx.createLinearGradient(0, 0, w, h);
                    grad.addColorStop(0, '#1a1a24');
                    grad.addColorStop(1, '#0b0b10');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, w, h);

                    const rgb1 = hlp.hexToRgb(color1);
                    const rgb2 = hlp.hexToRgb(color2);

                    const blob1 = ctx.createRadialGradient(w / 4, h / 2, 0, w / 4, h / 2, 800);
                    blob1.addColorStop(0, `rgba(${rgb1.r}, ${rgb1.g}, ${rgb1.b}, 0.2)`);
                    blob1.addColorStop(1, 'rgba(0, 0, 0, 0)');
                    ctx.fillStyle = blob1;
                    ctx.fillRect(0, 0, w, h);

                    const blob2 = ctx.createRadialGradient(w * 0.75, h / 2, 0, w * 0.75, h / 2, 800);
                    blob2.addColorStop(0, `rgba(${rgb2.r}, ${rgb2.g}, ${rgb2.b}, 0.2)`);
                    blob2.addColorStop(1, 'rgba(0, 0, 0, 0)');
                    ctx.fillStyle = blob2;
                    ctx.fillRect(0, 0, w, h);
                },
                'vibrant-glow': (ctx, w, h, { color1, color2 }, hlp) => {
                    const grad = ctx.createLinearGradient(0, 0, w, h);
                    grad.addColorStop(0, color1);
                    grad.addColorStop(1, color2);
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, w, h);

                    const rgb1 = hlp.hexToRgb(color1);
                    const rgb2 = hlp.hexToRgb(color2);

                    ctx.globalAlpha = 0.6;
                    const glow1 = ctx.createRadialGradient(w * 0.3, h * 0.3, 0, w * 0.3, h * 0.3, w * 0.8);
                    glow1.addColorStop(0, `rgba(${rgb1.r}, ${rgb1.g}, ${rgb1.b}, 1)`);
                    glow1.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = glow1;
                    ctx.fillRect(0, 0, w, h);

                    const glow2 = ctx.createRadialGradient(w * 0.7, h * 0.7, 0, w * 0.7, h * 0.7, w * 0.8);
                    glow2.addColorStop(0, `rgba(${rgb2.r}, ${rgb2.g}, ${rgb2.b}, 1)`);
                    glow2.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = glow2;
                    ctx.fillRect(0, 0, w, h);

                    // Seeded noise/grain
                    ctx.globalAlpha = 0.04;
                    for (let i = 0; i < 4000; i++) {
                        ctx.fillStyle = i % 2 === 0 ? '#ffffff' : '#000000';
                        ctx.fillRect(hlp.seededRand() * w, hlp.seededRand() * h, 2, 2);
                    }
                    ctx.globalAlpha = 1.0;
                    ctx.filter = 'none';
                },
                'minimal-glass': (ctx, w, h, { color1, color2 }, hlp) => {
                    ctx.fillStyle = '#f8fafc';
                    ctx.fillRect(0, 0, w, h);

                    ctx.fillStyle = color1;
                    ctx.beginPath(); ctx.arc(w - 200, 250, 400, 0, Math.PI * 2); ctx.fill();

                    ctx.fillStyle = color2;
                    ctx.beginPath(); ctx.arc(300, h - 300, 500, 0, Math.PI * 2); ctx.fill();

                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillRect(100, 100, w - 200, h - 200);
                    ctx.strokeStyle = 'rgba(255,255,255,0.9)';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(100, 100, w - 200, h - 200);
                },
                'cyberpunk': (ctx, w, h, { color1, color2 }, hlp) => {
                    ctx.fillStyle = '#050505';
                    ctx.fillRect(0, 0, w, h);

                    const rgb1 = hlp.hexToRgb(color1);
                    const rgb2 = hlp.hexToRgb(color2);

                    const g1 = ctx.createRadialGradient(w * 0.2, h * 0.3, 0, w * 0.2, h * 0.3, 600);
                    g1.addColorStop(0, `rgba(${rgb1.r}, ${rgb1.g}, ${rgb1.b}, 0.3)`);
                    g1.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = g1;
                    ctx.fillRect(0, 0, w, h);

                    const g2 = ctx.createRadialGradient(w * 0.8, h * 0.7, 0, w * 0.8, h * 0.7, 800);
                    g2.addColorStop(0, `rgba(${rgb2.r}, ${rgb2.g}, ${rgb2.b}, 0.25)`);
                    g2.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = g2;
                    ctx.fillRect(0, 0, w, h);

                    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < h; i += 4) {
                        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke();
                    }

                    ctx.fillStyle = color1;
                    ctx.globalAlpha = 0.2;
                    for (let i = 0; i < 5; i++) {
                        const gx = hlp.seededRand() * w;
                        const gy = hlp.seededRand() * h;
                        ctx.fillRect(gx, gy, hlp.seededRand() * 200, 2);
                    }
                    ctx.fillStyle = color2;
                    for (let i = 0; i < 5; i++) {
                        const gx = hlp.seededRand() * w;
                        const gy = hlp.seededRand() * h;
                        ctx.fillRect(gx, gy, hlp.seededRand() * 150, 1);
                    }
                    ctx.globalAlpha = 1.0;
                },
                'aurora': (ctx, w, h, { color1, color2 }, hlp) => {
                    ctx.fillStyle = '#0a0a1a';
                    ctx.fillRect(0, 0, w, h);

                    ctx.filter = 'blur(120px)';
                    ctx.globalAlpha = 0.4;

                    ctx.fillStyle = color1;
                    ctx.beginPath();
                    ctx.moveTo(-100, h * 0.5);
                    ctx.bezierCurveTo(w * 0.25, h * 0.2, w * 0.75, h * 0.8, w + 100, h * 0.4);
                    ctx.lineTo(w + 100, h * 0.6);
                    ctx.bezierCurveTo(w * 0.75, h * 0.9, w * 0.25, h * 0.3, -100, h * 0.7);
                    ctx.fill();

                    ctx.fillStyle = color2;
                    ctx.beginPath();
                    ctx.moveTo(-100, h * 0.2);
                    ctx.bezierCurveTo(w * 0.3, h * 0.5, w * 0.7, h * 0.1, w + 100, h * 0.3);
                    ctx.lineTo(w + 100, h * 0.4);
                    ctx.bezierCurveTo(w * 0.7, h * 0.2, w * 0.3, h * 0.6, -100, h * 0.3);
                    ctx.fill();

                    ctx.filter = 'none';
                    ctx.globalAlpha = 1.0;
                },
                'monochrome': (ctx, w, h, { color1, color2 }, hlp) => {
                    ctx.fillStyle = '#111827';
                    ctx.fillRect(0, 0, w, h);

                    ctx.fillStyle = color1;
                    ctx.globalAlpha = 0.1;
                    for (let i = 0; i < 8; i++) {
                        ctx.beginPath();
                        ctx.moveTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.lineTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.lineTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.fill();
                    }

                    ctx.fillStyle = color2;
                    ctx.globalAlpha = 0.05;
                    for (let i = 0; i < 12; i++) {
                        ctx.beginPath();
                        ctx.moveTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.lineTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.lineTo(hlp.seededRand() * w, hlp.seededRand() * h);
                        ctx.fill();
                    }
                    ctx.globalAlpha = 1.0;
                },
                'vintage': (ctx, w, h, { color1 }, hlp) => {
                    ctx.fillStyle = '#fdf4ff';
                    ctx.fillRect(0, 0, w, h);

                    ctx.fillStyle = color1;
                    ctx.globalAlpha = 0.15;
                    ctx.fillRect(0, 0, w, h);

                    const vig = ctx.createRadialGradient(w / 2, h / 2, w / 4, w / 2, h / 2, w);
                    vig.addColorStop(0, 'rgba(0,0,0,0)');
                    vig.addColorStop(1, 'rgba(0,0,0,0.6)');
                    ctx.fillStyle = vig;
                    ctx.globalAlpha = 1.0;
                    ctx.fillRect(0, 0, w, h);

                    ctx.fillStyle = '#000000';
                    ctx.globalAlpha = 0.05;
                    for (let i = 0; i < 2000; i++) {
                        ctx.fillRect(hlp.seededRand() * w, hlp.seededRand() * h, 1, 1);
                    }
                    ctx.globalAlpha = 1.0;
                }
            };

            if (themeFunctions[theme]) {
                themeFunctions[theme](ctx, w, h, { color1, color2 }, helpers);
            }

            // Reset state after theme drawing
            ctx.filter = 'none';
            ctx.globalAlpha = 1.0;
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';

            // --- Independent Border Drawing ---
            const borderStyle = document.getElementById('cover-border-style').value;
            const borderColor = document.getElementById('cover-border-color').value;

            if (borderStyle !== 'none') {
                if (borderStyle === 'elegant') {
                    const m = 40;
                    ctx.strokeStyle = borderColor;
                    ctx.lineWidth = 12; ctx.globalAlpha = 0.15;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 20); ctx.stroke();
                    ctx.lineWidth = 2; ctx.globalAlpha = 0.9;
                    roundRect(ctx, m + 4, m + 4, w - (m + 4) * 2, h - (m + 4) * 2, 16); ctx.stroke();
                    ctx.globalAlpha = 1.0;
                }
                else if (borderStyle === 'bold-frame') {
                    const m = 45;
                    ctx.shadowColor = 'rgba(0,0,0,0.6)'; ctx.shadowBlur = 30; ctx.shadowOffsetY = 15;
                    ctx.strokeStyle = borderColor; ctx.lineWidth = 30;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 35); ctx.stroke();
                    ctx.shadowColor = 'transparent';
                    ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 4;
                    const im = m + 13; roundRect(ctx, im, im, w - im * 2, h - im * 2, 22); ctx.stroke();
                    ctx.strokeStyle = 'rgba(0,0,0,0.4)'; ctx.lineWidth = 4;
                    const om = m - 13; roundRect(ctx, om, om, w - om * 2, h - om * 2, 48); ctx.stroke();
                }
                else if (borderStyle === 'neon-glow') {
                    const m = 55;
                    ctx.shadowColor = borderColor; ctx.shadowBlur = 80;
                    ctx.strokeStyle = borderColor; ctx.lineWidth = 15; ctx.globalAlpha = 0.4;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 30); ctx.stroke();
                    ctx.shadowBlur = 20; ctx.lineWidth = 8; ctx.globalAlpha = 0.8;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 30); ctx.stroke();
                    ctx.shadowColor = 'transparent'; ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 4; ctx.globalAlpha = 1.0;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 30); ctx.stroke();
                }
                else if (borderStyle === 'tech-corners') {
                    const m = 50; const len = 140; const chamfer = 25;
                    ctx.strokeStyle = borderColor; ctx.lineWidth = 8; ctx.lineJoin = 'miter';
                    ctx.beginPath();
                    ctx.moveTo(m, m + len); ctx.lineTo(m, m + chamfer); ctx.lineTo(m + chamfer, m); ctx.lineTo(m + len, m);
                    ctx.moveTo(w - m - len, m); ctx.lineTo(w - m - chamfer, m); ctx.lineTo(w - m, m + chamfer); ctx.lineTo(w - m, m + len);
                    ctx.moveTo(w - m, h - m - len); ctx.lineTo(w - m, h - m - chamfer); ctx.lineTo(w - m - chamfer, h - m); ctx.lineTo(w - m - len, h - m);
                    ctx.moveTo(m + len, h - m); ctx.lineTo(m + chamfer, h - m); ctx.lineTo(m, h - m - chamfer); ctx.lineTo(m, h - m - len);
                    ctx.stroke();
                    ctx.lineWidth = 2; ctx.globalAlpha = 0.5; const im = m + 18;
                    ctx.beginPath();
                    ctx.moveTo(im, im + len - 20); ctx.lineTo(im, im); ctx.lineTo(im + len - 20, im);
                    ctx.moveTo(w - im - len + 20, im); ctx.lineTo(w - im, im); ctx.lineTo(w - im, im + len - 20);
                    ctx.moveTo(w - im, h - im - len + 20); ctx.lineTo(w - im, h - im); ctx.lineTo(w - im - len + 20, h - im);
                    ctx.moveTo(im + len - 20, h - im); ctx.lineTo(im, h - im); ctx.lineTo(im, h - im - len + 20);
                    ctx.stroke(); ctx.globalAlpha = 1.0;
                    ctx.fillStyle = borderColor; const blockOffset = m + len + 15;
                    ctx.fillRect(blockOffset, m - 4, 30, 8); ctx.fillRect(blockOffset + 40, m - 4, 10, 8);
                    ctx.fillRect(w - blockOffset - 30, m - 4, 30, 8);
                    ctx.fillRect(blockOffset, h - m - 4, 40, 8); ctx.fillRect(w - blockOffset - 20, h - m - 4, 20, 8);
                    ctx.fillRect(w - blockOffset - 40, h - m - 4, 10, 8);
                }
                else if (borderStyle === 'double-inset') {
                    const m1 = 40; const m2 = 55; ctx.strokeStyle = borderColor; ctx.lineWidth = 2;
                    roundRect(ctx, m1, m1, w - m1 * 2, h - m1 * 2, 20); ctx.stroke();
                    roundRect(ctx, m2, m2, w - m2 * 2, h - m2 * 2, 10); ctx.stroke();
                }
                else if (borderStyle === 'corner-brackets') {
                    const m = 40; const len = 100; ctx.strokeStyle = borderColor; ctx.lineWidth = 12; ctx.lineCap = 'square';
                    ctx.beginPath(); ctx.moveTo(m, m + len); ctx.lineTo(m, m); ctx.lineTo(m + len, m); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(w - m - len, m); ctx.lineTo(w - m, m); ctx.lineTo(w - m, m + len); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(w - m, h - m - len); ctx.lineTo(w - m, h - m); ctx.lineTo(w - m - len, h - m); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(m + len, h - m); ctx.lineTo(m, h - m); ctx.lineTo(m, h - m - len); ctx.stroke();
                }
                else if (borderStyle === 'industrial-dash') {
                    const m = 50; ctx.strokeStyle = borderColor; ctx.lineWidth = 8; ctx.setLineDash([40, 20]);
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 20); ctx.stroke(); ctx.setLineDash([]);
                }
                else if (borderStyle === 'ornate') {
                    const m = 60; ctx.strokeStyle = borderColor; ctx.lineWidth = 4;
                    roundRect(ctx, m, m, w - m * 2, h - m * 2, 30); ctx.stroke();
                    const r = 15; ctx.fillStyle = borderColor;
                    ctx.beginPath(); ctx.arc(w / 2, m, r, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(w / 2, h - m, r, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(m, h / 2, r, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(w - m, h / 2, r, 0, Math.PI * 2); ctx.fill();
                }
            }

            // Reset state before text drawing
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1.0;
            ctx.filter = 'none';

            // --- Draw Text ---
            if (theme === 'modern-dark') {
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 120px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                wrapText(ctx, text, w / 2, h / 2 + 50, w - 200, 140);
            }
            else if (theme === 'vibrant-glow') {
                ctx.fillStyle = '#ffffff';
                ctx.font = '800 140px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 30;
                wrapText(ctx, text, w / 2, h / 2, w - 200, 160);
            }
            else if (theme === 'minimal-glass') {
                ctx.fillStyle = '#0f172a';
                ctx.font = '600 130px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                wrapText(ctx, text, w / 2, h / 2, w - 300, 150);
            }
            else if (theme === 'cyberpunk') {
                ctx.fillStyle = '#ffffff';
                ctx.font = '900 150px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.shadowColor = color1; ctx.shadowBlur = 20;
                wrapText(ctx, text, w / 2, h / 2, w - 200, 170);
            }
            else if (theme === 'aurora') {
                ctx.fillStyle = '#ffffff';
                ctx.font = '300 140px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.filter = 'blur(1px)';
                wrapText(ctx, text, w / 2, h / 2, w - 300, 160);
            }
            else if (theme === 'monochrome') {
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 160px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                wrapText(ctx, text, w / 2, h / 2, w - 200, 180);
            }
            else if (theme === 'vintage') {
                ctx.fillStyle = '#422006';
                ctx.font = 'italic 500 120px "Outfit", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.globalAlpha = 0.8;
                wrapText(ctx, text, w / 2, h / 2, w - 300, 140);
            }

            // Final state reset
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1.0;
            ctx.filter = 'none';
        }

        // Helper to draw rounded rectangles on canvas natively
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let lines = [];
            for (let n = 0; n < words.length; n++) {
                let word = words[n];
                let testLine = line + word + ' ';
                let metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth) {
                    if (line !== '') {
                        lines.push(line);
                        line = '';
                        testLine = word + ' ';
                        metrics = ctx.measureText(testLine);
                    }
                    if (metrics.width > maxWidth) {
                        let chars = word.split('');
                        let segment = '';
                        for (let c = 0; c < chars.length; c++) {
                            let testSegment = segment + chars[c];
                            if (ctx.measureText(testSegment).width > maxWidth && segment !== '') {
                                lines.push(segment);
                                segment = chars[c];
                            } else {
                                segment = testSegment;
                            }
                        }
                        line = segment + ' ';
                    } else {
                        line = word + ' ';
                    }
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            let startY = y - ((lines.length - 1) * lineHeight) / 2;
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i].trim(), x, startY + (i * lineHeight));
            }
        }

        function downloadCover() {
            if (activeCoverIndex < 0) return;
            const group = currentConfig.groups[activeCoverIndex];
            const canvas = document.getElementById('cover-canvas');
            const dataUrl = canvas.toDataURL('image/jpeg', 0.92);

            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = (group.name || 'group_cover') + '_cover.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showStatus('Downloaded cover!', 'success');
        }

        async function applyCover() {
            if (activeCoverIndex < 0) return;
            const group = currentConfig.groups[activeCoverIndex];

            const canvas = document.getElementById('cover-canvas');
            const dataUrl = canvas.toDataURL('image/jpeg', 0.92);

            try {
                const response = await fetch('/api/upload_cover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_name: group.name, image: dataUrl })
                });

                if (response.ok) {
                    showStatus('Cover generated and saved!', 'success');

                    // Save explicit aesthetic config directly back to the group
                    group.cover_text = document.getElementById('cover-text').value;
                    group.cover_theme = document.getElementById('cover-theme').value;
                    group.cover_border_style = document.getElementById('cover-border-style').value;
                    group.cover_border_color = document.getElementById('cover-border-color').value;
                    group.cover_color1 = document.getElementById('cover-color-1').value;
                    group.cover_color2 = document.getElementById('cover-color-2').value;

                    await saveAllConfig();
                    closeModal('cover-generator-modal');
                } else {
                    showStatus('Failed to upload cover image.', 'error');
                }
            } catch (err) {
                showStatus('Network error while saving cover.', 'error');
            }
        }

        async function deleteGroup(index) {
            if (confirm('Permanently remove this grouping?')) {
                const groupName = currentConfig.groups[index]?.name;
                if (editingIndex === index) cancelEdit();
                currentConfig.groups.splice(index, 1);
                await saveAllConfig();

                if (groupName) {
                    try {
                        await fetch('/api/cleanup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folders: [groupName] })
                        });
                    } catch (e) {
                        console.error('Failed to cleanup folder from disk:', e);
                    }
                }
            }
        }

        async function clearAllGroups() {
            if (confirm('Are you sure you want to remove ALL groupings? This cannot be undone.')) {
                const groupNames = currentConfig.groups.map(g => g.name).filter(Boolean);
                currentConfig.groups = [];
                await saveAllConfig();

                if (groupNames.length > 0) {
                    try {
                        await fetch('/api/cleanup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folders: groupNames })
                        });
                    } catch (e) {
                        console.error('Failed to cleanup folders from disk:', e);
                    }
                }
            }
        }

        // --- Streamlined Import / Export Logic ---

        function openExportModal() {
            const container = document.getElementById('export-groups-container');
            container.innerHTML = '';

            if (currentConfig.groups.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No groups available to export.</p>';
            } else {
                currentConfig.groups.forEach((g, i) => {
                    const item = document.createElement('div');
                    item.className = 'modal-item';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = true;
                    cb.className = 'export-check';
                    cb.dataset.index = i;
                    cb.setAttribute('style', 'width:18px; height:18px; accent-color: var(--accent-color);');
                    item.appendChild(cb);

                    const labelDiv = document.createElement('div');
                    const nameDiv = document.createElement('div');
                    nameDiv.setAttribute('style', 'font-weight:600; font-size:0.95rem;');
                    nameDiv.textContent = g.name || 'Unnamed Group';
                    const typeDiv = document.createElement('div');
                    typeDiv.setAttribute('style', 'font-size:0.8rem; color:var(--text-secondary);');
                    typeDiv.textContent = g.source_type || '';
                    labelDiv.appendChild(nameDiv);
                    labelDiv.appendChild(typeDiv);
                    item.appendChild(labelDiv);

                    container.appendChild(item);
                });
            }

            document.querySelector('input[name="export-type"][value="all"]').checked = true;
            toggleExportSelection();
            document.getElementById('export-modal').style.display = 'flex';
        }

        function toggleExportSelection() {
            const type = document.querySelector('input[name="export-type"]:checked').value;
            document.getElementById('export-selection-list').style.display = (type === 'selective') ? 'block' : 'none';
        }

        function execExport() {
            const type = document.querySelector('input[name="export-type"]:checked').value;
            let dataToExport = {};
            let filename = 'jellyfin-groupings-export.json';

            if (type === 'all') {
                dataToExport = currentConfig;
                filename = 'jellyfin-config-full.json';
            } else {
                const selectedIndices = Array.from(document.querySelectorAll('.export-check:checked'))
                    .map(cb => parseInt(cb.dataset.index));

                if (selectedIndices.length === 0) {
                    alert('Please select at least one grouping.');
                    return;
                }
                dataToExport = { groups: selectedIndices.map(i => currentConfig.groups[i]) };
                filename = 'jellyfin-selected-groupings.json';
            }

            downloadJSON(dataToExport, filename);
            closeModal('export-modal');
        }

        function openImportModal() {
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('cancel-import-top').style.display = 'block';
            document.getElementById('import-modal').style.display = 'flex';
        }

        function handleFileSelected(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    pendingImportData = data;
                    setupImportStep2(data);
                } catch (err) {
                    showStatus('Invalid JSON file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset
        }

        function setupImportStep2(data) {
            document.getElementById('import-step-1').style.display = 'none';
            document.getElementById('import-step-2').style.display = 'block';
            document.getElementById('cancel-import-top').style.display = 'none';

            const warning = document.getElementById('import-warning');
            const selectionList = document.getElementById('import-selection-list');
            const container = document.getElementById('import-groups-container');
            const confirmBtn = document.getElementById('confirm-import');

            container.innerHTML = '';

            // Detection: Is it a full config or just groups?
            const isFullConfig = data.jellyfin_url !== undefined && data.api_key !== undefined;
            const groups = data.groups || (Array.isArray(data) ? data : null);

            if (isFullConfig) {
                warning.style.display = 'block';
                selectionList.style.display = 'none';
                confirmBtn.textContent = 'Overwrite All';
                confirmBtn.onclick = () => performImport('full');
            } else if (groups) {
                warning.style.display = 'none';
                selectionList.style.display = 'block';
                confirmBtn.textContent = 'Import Selected';

                groups.forEach((g, i) => {
                    const item = document.createElement('div');
                    item.className = 'modal-item';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = true;
                    cb.className = 'import-check';
                    cb.dataset.index = i;
                    cb.setAttribute('style', 'width:18px; height:18px; accent-color: var(--accent-color);');
                    item.appendChild(cb);

                    const labelDiv = document.createElement('div');
                    const nameDiv = document.createElement('div');
                    nameDiv.setAttribute('style', 'font-weight:600; font-size:0.95rem;');
                    nameDiv.textContent = g.name || 'Unnamed Group';
                    const typeDiv = document.createElement('div');
                    typeDiv.setAttribute('style', 'font-size:0.8rem; color:var(--text-secondary);');
                    typeDiv.textContent = `${g.source_type || ''}: ${g.source_value || ''}`;
                    labelDiv.appendChild(nameDiv);
                    labelDiv.appendChild(typeDiv);
                    item.appendChild(labelDiv);

                    container.appendChild(item);
                });
                confirmBtn.onclick = () => performImport('groups', groups);
            } else {
                showStatus('Incompatible file structure', 'error');
                closeModal('import-modal');
            }
        }

        async function performImport(type, sourceGroups = null) {
            if (type === 'full') {
                currentConfig = pendingImportData;
            } else {
                const selectedIndices = Array.from(document.querySelectorAll('.import-check:checked'))
                    .map(cb => parseInt(cb.dataset.index));

                const toImport = selectedIndices.map(i => sourceGroups[i]);
                currentConfig.groups = [...currentConfig.groups, ...toImport];
            }

            await saveAllConfig();
            closeModal('import-modal');
            showStatus('Import successful!', 'success');
            loadConfig();
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            pendingImportData = null;
        }

        async function autoDetectPaths() {
            const detectBtn = document.getElementById('auto-detect-btn');
            detectBtn.classList.add('btn-loading');
            try {
                const result = await fetchAutoDetect();
                if (result.status === 'success' && result.detected.media_path_on_host) {
                    document.getElementById('media_path_in_jellyfin').value = result.detected.media_path_in_jellyfin;
                    document.getElementById('media_path_on_host').value = result.detected.media_path_on_host;
                    document.getElementById('target_path').value = result.detected.target_path;
                    document.getElementById('target_path_in_jellyfin').value = result.detected.target_path_in_jellyfin;
                    currentConfig.media_path_in_jellyfin = result.detected.media_path_in_jellyfin;
                    currentConfig.media_path_on_host = result.detected.media_path_on_host;
                    currentConfig.target_path = result.detected.target_path;
                    currentConfig.target_path_in_jellyfin = result.detected.target_path_in_jellyfin;
                    showStatus('Paths auto-detected! Remember to Save.', 'success');
                } else if (result.status === 'success') {
                    showStatus('Auto-detection finished but could not find matching host paths. You may need to set them manually.', 'error');
                } else {
                    showStatus(result.message || 'Auto-detection failed', 'error');
                }
            } catch (err) {
                showStatus('Auto-detection failed - API unreachable', 'error');
            } finally {
                detectBtn.classList.remove('btn-loading');
            }
        }

        async function fetchAutoDetect() {
            const resp = await fetch('/api/jellyfin/auto-detect-paths', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            return resp.json();
        }

        /** Called silently after a successful test; fills only empty path fields. */
        async function autoDetectIfEmpty() {
            const targetEl = document.getElementById('target_path');
            const jfEl = document.getElementById('media_path_in_jellyfin');
            const hostEl = document.getElementById('media_path_on_host');
            if (targetEl.value && jfEl.value && hostEl.value) return;
            try {
                const result = await fetchAutoDetect();
                if (result.status !== 'success') return;
                const d = result.detected;
                if (!targetEl.value && d.target_path) { targetEl.value = d.target_path; currentConfig.target_path = d.target_path; }
                if (!jfEl.value && d.media_path_in_jellyfin) { jfEl.value = d.media_path_in_jellyfin; currentConfig.media_path_in_jellyfin = d.media_path_in_jellyfin; }
                if (!hostEl.value && d.media_path_on_host) { hostEl.value = d.media_path_on_host; currentConfig.media_path_on_host = d.media_path_on_host; }
                if (d.target_path_in_jellyfin) { document.getElementById('target_path_in_jellyfin').value = d.target_path_in_jellyfin; currentConfig.target_path_in_jellyfin = d.target_path_in_jellyfin; }
                showStatus('Paths auto-filled â€” review and save.', 'success');
            } catch (_) { /* silently ignore */ }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Folder Picker
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _pickerTargetId = null;
        let _pickerCurrentPath = null;

        async function openPathPicker(fieldId) {
            _pickerTargetId = fieldId;
            const currentVal = document.getElementById(fieldId).value;
            document.getElementById('picker-title').textContent =
                fieldId === 'target_path' ? 'Select Target Path' :
                    fieldId === 'media_path_in_jellyfin' ? 'Select Media Path (Jellyfin side)' :
                        'Select Media Path (this machine)';
            document.getElementById('path-picker-modal').style.display = 'flex';
            await browseDir(currentVal || '');
        }

        async function browseDir(path) {
            document.getElementById('picker-body').innerHTML =
                '<p style="padding:1.5rem; text-align:center; color:var(--text-secondary);">Loadingâ€¦</p>';
            let result;
            try {
                const resp = await fetch('/api/browse?path=' + encodeURIComponent(path));
                result = await resp.json();
            } catch (e) {
                const errP = document.createElement('p');
                errP.className = 'picker-empty';
                errP.textContent = `Could not load directory: ${e.message}`;
                document.getElementById('picker-body').appendChild(errP);
                return;
            }
            if (result.status !== 'success') {
                const errP = document.createElement('p');
                errP.className = 'picker-empty';
                errP.textContent = result.message;
                document.getElementById('picker-body').appendChild(errP);
                return;
            }
            _pickerCurrentPath = result.current;
            document.getElementById('picker-breadcrumb').textContent = result.current;
            document.getElementById('picker-footer-path').textContent = result.current;

            const body = document.getElementById('picker-body');
            body.innerHTML = '';

            if (result.parent) {
                const up = document.createElement('button');
                up.className = 'picker-item picker-up';
                up.innerHTML = '<span class="picker-item-icon">â¬†ï¸</span> .. (go up)';
                up.onclick = () => browseDir(result.parent);
                body.appendChild(up);
            }

            if (result.dirs.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'picker-empty';
                empty.textContent = 'No subdirectories here.';
                body.appendChild(empty);
            } else {
                result.dirs.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = 'picker-item';
                    const fullPath = result.current.replace(/\/$/, '') + '/' + name;
                    const icon = document.createElement('span');
                    icon.className = 'picker-item-icon';
                    icon.textContent = 'ğŸ“';
                    btn.appendChild(icon);
                    btn.appendChild(document.createTextNode(' ' + name));
                    btn.title = fullPath;
                    btn.onclick = () => browseDir(fullPath);
                    body.appendChild(btn);
                });
            }
        }

        function confirmPicker() {
            if (_pickerTargetId && _pickerCurrentPath) {
                document.getElementById(_pickerTargetId).value = _pickerCurrentPath;
            }
            closePicker();
        }

        function closePicker() {
            document.getElementById('path-picker-modal').style.display = 'none';
            _pickerTargetId = null;
        }

        function pickerOutsideClick(e) {
            if (e.target === document.getElementById('path-picker-modal')) closePicker();
        }

        async function openCleanupModal() {
            document.getElementById('cleanup-modal').style.display = 'flex';
            document.getElementById('cleanup-loading').style.display = 'flex';
            document.getElementById('cleanup-content').style.display = 'none';
            document.getElementById('cleanup-error').style.display = 'none';

            try {
                const response = await fetch('/api/cleanup');
                const result = await response.json();

                if (result.status === 'success') {
                    const listContainer = document.getElementById('cleanup-list');
                    listContainer.innerHTML = '';

                    if (!result.items || result.items.length === 0) {
                        listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-style: italic;">No folders found in Target Directory.</div>';
                    } else {
                        result.items.forEach(item => {
                            const row = document.createElement('label');
                            row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 0.8rem; border-bottom: 1px solid var(--glass-border); cursor: pointer; transition: background 0.15s; text-transform: none; font-weight: 400;';
                            row.onmouseover = () => row.style.background = 'rgba(255,255,255,0.05)';
                            row.onmouseout = () => row.style.background = 'transparent';

                            const left = document.createElement('div');
                            left.style.display = 'flex';
                            left.style.alignItems = 'center';
                            left.style.gap = '1rem';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = item.name;
                            checkbox.checked = true; // Default: select all for cleanup as requested
                            checkbox.style.cssText = 'width: 16px; height: 16px; accent-color: var(--error-color);';
                            checkbox.onchange = updateCleanupCount;

                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = item.name;
                            nameSpan.style.color = 'var(--text-primary)';
                            nameSpan.style.fontFamily = 'monospace';

                            const badge = document.createElement('span');
                            if (item.is_configured) {
                                badge.textContent = 'Configured';
                                badge.style.cssText = 'font-size: 0.7rem; background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 0.2rem 0.5rem; border-radius: 4px;';
                            } else {
                                badge.textContent = 'Unconfigured';
                                badge.style.cssText = 'font-size: 0.7rem; background: rgba(239, 68, 68, 0.2); color: #f87171; padding: 0.2rem 0.5rem; border-radius: 4px;';
                            }

                            left.appendChild(checkbox);
                            left.appendChild(nameSpan);
                            row.appendChild(left);
                            row.appendChild(badge);
                            listContainer.appendChild(row);
                        });
                    }

                    document.getElementById('cleanup-loading').style.display = 'none';
                    document.getElementById('cleanup-content').style.display = 'flex';
                    updateCleanupCount();
                } else {
                    document.getElementById('cleanup-loading').style.display = 'none';
                    document.getElementById('cleanup-error').textContent = result.message || 'Failed to load folders';
                    document.getElementById('cleanup-error').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('cleanup-loading').style.display = 'none';
                document.getElementById('cleanup-error').textContent = 'Network error fetching folders';
                document.getElementById('cleanup-error').style.display = 'block';
            }
        }

        function updateCleanupCount() {
            const checked = document.querySelectorAll('#cleanup-list input[type="checkbox"]:checked').length;
            const countSpan = document.getElementById('cleanup-count');
            countSpan.textContent = checked > 0 ? `(${checked})` : '';
            document.getElementById('confirm-cleanup-btn').disabled = checked === 0;
            document.getElementById('confirm-cleanup-btn').style.opacity = checked === 0 ? '0.5' : '1';
        }

        async function execCleanup() {
            const checkboxes = document.querySelectorAll('#cleanup-list input[type="checkbox"]:checked');
            const folders = Array.from(checkboxes).map(cb => cb.value);

            if (folders.length === 0) return;

            const btn = document.getElementById('confirm-cleanup-btn');
            btn.innerHTML = '<span class="loading-spinner" style="display:inline-block; border-top-color:#fff; width:16px; height:16px;border-width:2px;margin-right:8px;"></span>Deleting...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folders })
                });
                const result = await response.json();

                btn.innerHTML = 'Delete Selected <span id="cleanup-count"></span>';
                btn.disabled = false;

                if (result.status === 'success' || result.status === 'partial_success') {
                    closeModal('cleanup-modal');
                    alert(`Successfully deleted ${result.deleted} folder(s). ${result.errors ? 'Errors: ' + result.errors.join(', ') : ''}`);
                } else {
                    alert('Error deleting folders: ' + result.message);
                }
            } catch (err) {
                btn.innerHTML = 'Delete Selected <span id="cleanup-count"></span>';
                btn.disabled = false;
                alert('Network error while deleting folders.');
            }
        }

        async function previewSyncAll() {
            const btn = document.getElementById('preview-sync-btn');
            btn.classList.add('btn-loading');
            try {
                const response = await fetch('/api/sync/preview_all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.status === 'success') {
                    const container = document.getElementById('preview-sync-results');
                    container.innerHTML = '';

                    if (result.results && result.results.length > 0) {
                        result.results.forEach(groupResult => {
                            const groupCard = document.createElement('div');
                            groupCard.style.cssText = 'background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 1rem;';

                            const header = document.createElement('div');
                            header.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;';

                            const name = document.createElement('strong');
                            name.textContent = groupResult.group;
                            name.style.fontSize = '1.1rem';

                            const badge = document.createElement('span');
                            badge.textContent = `${groupResult.links} items`;
                            badge.style.cssText = 'background: var(--accent-color); color: #fff; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;';

                            header.appendChild(name);
                            header.appendChild(badge);
                            groupCard.appendChild(header);

                            if (groupResult.error) {
                                const err = document.createElement('div');
                                err.style.cssText = 'color: var(--error-color); font-size: 0.85rem; margin-top: 0.5rem;';
                                err.textContent = `Error: ${groupResult.error}`;
                                groupCard.appendChild(err);
                            } else if (groupResult.items && groupResult.items.length > 0) {
                                const list = document.createElement('ul');
                                list.style.cssText = 'margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: var(--text-secondary); max-height: 150px; overflow-y: auto;';

                                groupResult.items.forEach((item) => {
                                    const li = document.createElement('li');
                                    li.textContent = item.Year ? `${item.Name} (${item.Year})` : item.Name;
                                    list.appendChild(li);
                                });

                                groupCard.appendChild(list);
                            } else {
                                const empty = document.createElement('div');
                                empty.style.cssText = 'color: var(--text-secondary); font-size: 0.85rem; font-style: italic;';
                                empty.textContent = 'No items found for this group.';
                                groupCard.appendChild(empty);
                            }

                            container.appendChild(groupCard);
                        });
                    } else {
                        container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; padding: 1rem;">No groupings configured.</div>';
                    }

                    document.getElementById('preview-sync-modal').style.display = 'flex';
                } else {
                    showStatus(result.message || 'Preview failed', 'error');
                }
            } catch (err) {
                showStatus('Preview failed - API unreachable', 'error');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        async function syncAll() {
            const syncBtn = document.getElementById('sync-btn');
            syncBtn.classList.add('btn-loading');
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    let totalLinks = result.results.reduce((acc, r) => acc + r.links, 0);
                    showStatus(`Sync complete! Created ${totalLinks} symbolic links.`, 'success');
                } else {
                    showStatus(result.message || 'Sync failed', 'error');
                }
            } catch (err) {
                showStatus('Sync failed - API unreachable', 'error');
            } finally {
                syncBtn.classList.remove('btn-loading');
            }
        }

        // Initialize
        if (window.location.protocol === 'file:') {
            document.getElementById('connection-warning').style.display = 'block';
        } else {
            loadConfig();
        }
        // --- Sidebar Resizer Logic ---
        const resizer = document.getElementById('sidebar-resizer');
        let isResizing = false;

        // Load saved width
        const savedWidth = localStorage.getItem('sidebarWidth');
        if (savedWidth) {
            document.documentElement.style.setProperty('--sidebar-width', `${savedWidth}px`);
        }

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('active');
            document.body.style.cursor = 'col-resize';
            e.preventDefault(); // prevent text selection
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let newWidth = e.clientX;
            // Constrain width
            if (newWidth < 200) newWidth = 200;
            if (newWidth > 800) newWidth = 800;

            document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('active');
                document.body.style.cursor = 'default';

                // Save width setting
                const currentWidth = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width').replace('px', '').trim();
                localStorage.setItem('sidebarWidth', currentWidth);
            }
        });
    </script>
</body>

</html>